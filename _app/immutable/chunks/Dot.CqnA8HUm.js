import{s as ne,w as I,x as M,b as D,f as z,o as y,i as me,h as j,n as Z,k as W,B as F,O as pe,P as ve}from"./scheduler.B1B1O6BW.js";import{S as ie,i as ae}from"./index.Ba0icOcB.js";import{c as ye,m as k,a as T,O as Ce}from"./map.Ds7gtR3S.js";import{s as N,e as J,f as we,A as $,c as q,g as Ee,h as H,a as _e,j as ee,b as te}from"./store.BH0i9ObR.js";import{g as se,a as Pe}from"./sign.BmioQ45-.js";import{e as R}from"./emitter.E5P-NQ8u.js";import{g as oe}from"./overlay.D2uvO7-w.js";import{s as V}from"./Map.CM38Pq8n.js";function Oe(_){let f,C,r,O,p,w;return{c(){f=I("svg"),C=I("g"),r=I("path"),O=I("defs"),p=I("clipPath"),w=I("rect"),this.h()},l(P){f=M(P,"svg",{width:!0,height:!0,viewBox:!0,fill:!0,xmlns:!0});var h=D(f);C=M(h,"g",{"clip-path":!0});var x=D(C);r=M(x,"path",{d:!0,fill:!0}),D(r).forEach(z),x.forEach(z),O=M(h,"defs",{});var E=D(O);p=M(E,"clipPath",{id:!0});var b=D(p);w=M(b,"rect",{width:!0,height:!0,fill:!0}),D(w).forEach(z),b.forEach(z),E.forEach(z),h.forEach(z),this.h()},h(){y(r,"d","M12 24C15.1826 24 18.2348 22.7357 20.4853 20.4853C22.7357 18.2348 24 15.1826 24 12C24 8.8174 22.7357 5.76515 20.4853 3.51472C18.2348 1.26428 15.1826 0 12 0C8.8174 0 5.76515 1.26428 3.51472 3.51472C1.26428 5.76515 0 8.8174 0 12C0 15.1826 1.26428 18.2348 3.51472 20.4853C5.76515 22.7357 8.8174 24 12 24ZM8.26875 8.25C8.66657 8.25 9.04811 8.40804 9.32941 8.68934C9.61071 8.97064 9.76875 9.35217 9.76875 9.75C9.76875 10.1478 9.61071 10.5294 9.32941 10.8107C9.04811 11.092 8.66657 11.25 8.26875 11.25C7.87092 11.25 7.48939 11.092 7.20809 10.8107C6.92679 10.5294 6.76875 10.1478 6.76875 9.75C6.76875 9.35217 6.92679 8.97064 7.20809 8.68934C7.48939 8.40804 7.87092 8.25 8.26875 8.25ZM14.2687 9.75C14.2687 9.35217 14.4268 8.97064 14.7081 8.68934C14.9894 8.40804 15.3709 8.25 15.7687 8.25C16.1666 8.25 16.5481 8.40804 16.8294 8.68934C17.1107 8.97064 17.2687 9.35217 17.2687 9.75C17.2687 10.1478 17.1107 10.5294 16.8294 10.8107C16.5481 11.092 16.1666 11.25 15.7687 11.25C15.3709 11.25 14.9894 11.092 14.7081 10.8107C14.4268 10.5294 14.2687 10.1478 14.2687 9.75ZM7.5 15.75L16.5 15.75C16.9125 15.75 17.25 16.0875 17.25 16.5C17.25 16.9125 16.9125 17.25 16.5 17.25H7.5C7.0875 17.25 6.75 16.9125 6.75 16.5C6.75 16.0875 7.0875 15.75 7.5 15.75Z"),y(r,"fill","white"),y(C,"clip-path","url(#clip0_271_2686)"),y(w,"width","24"),y(w,"height","24"),y(w,"fill","white"),y(p,"id","clip0_271_2686"),y(f,"width","24"),y(f,"height","24"),y(f,"viewBox","0 0 24 24"),y(f,"fill","none"),y(f,"xmlns","http://www.w3.org/2000/svg")},m(P,h){me(P,f,h),j(f,C),j(C,r),j(f,O),j(O,p),j(p,w)},p:Z,i:Z,o:Z,d(P){P&&z(f)}}}class ke extends ie{constructor(f){super(),ae(this,f,null,Oe,ne,{})}}let Se=50;const re=10;function ze(_=0){const f=document.createElement("div");return f.innerHTML=`<img class="dot-avatar" />
    <svg class="dot-spining-emoji" viewBox="0 0 100 100">
      <defs>
        <filter id="shadow-${_}">
          <feDropShadow
            dx="2"
            dy="2"
            stdDeviation="3"
            flood-color="#000000"
            flood-opacity="0.14"
          />
        </filter>
      </defs>
      <path
        id="text-path"
        d="M 50,50 m -30,0 a 30,30 0 1,1 60,0 a 30,30 0 1,1 -60,0"
        fill="none"
      />
      <text font-size="12" dy="-3" letter-spacing="10" filter="url(#shadow-${_})">
        <textPath href="#text-path" startOffset="0">
        </textPath>
      </text>
    </svg>
    `,f}function be(_,f,C){let r,O;W(_,N,s=>C(7,r=s)),W(_,J,s=>C(8,O=s));let p=null,w=null;const P=ye(),h={},x=[];let E=null,b=!1,A=0;const ce=we.subscribe(s=>{if(s){if(r)return;p=se(),w=Pe(),fetch(`${$}/posts/dots/my`,{headers:{Authorization:`Bearer ${p}`,"x-api-version":q.DOTS}}).then(o=>o.json()).then(o=>{const a=o.data;F(N,r=a.map(c=>({...c,ownerIdx:c.owner_idx,image:V(c.image_url),size:oe(c.score)})),r),B()})}else p=null,r&&(x.forEach(o=>{o.get("ownerIdx")===`${w}`&&(o.set("idx",void 0),o.setPosition(void 0))}),F(N,r=null,r),w=null)});let G="sun";const le=Ee.subscribe(s=>{G=s,B()}),de=H.subscribe(s=>{s?x.forEach(o=>{const a=o.getElement();a&&(a.style.display="flex")}):x.forEach(o=>{const a=o.getElement();a&&(a.style.display="none")})});_e.subscribe(s=>{E&&(s.length>0&&O&&(J.set(!1),ee.set(!1),H.set(!1),te.set(!0)),s.length===5&&E&&!b&&U(E),s.length===0&&C(0,E=null))});function U(s){b=!0;const[o,a,c]=s;fetch(`${$}/posts/dots/${o}/${a}/${c}?offset=${A}&limit=${re}`,{headers:{Authorization:`Bearer ${p}`,"x-api-version":q.DOTS}}).then(g=>g.json()).then(g=>{const m=g.data;m.length!==0&&(m.forEach(e=>{if(r!=null&&r.some(t=>t.idx===e.idx))return;const u=async t=>{const i=se();i&&await fetch(`${$}/vote/reactions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({type:t,targetTable:"dots",targetId:e.idx})})};R.emit("unshiftCard",{idx:e.idx,type:"photo",ownerIdx:e.owner_idx,image:V(e.image_url),emoji:e.emojis,back:e.text,left:ke,leftColor:"bg-[#757D86]",right:"🤍",rightColor:"positive",onPreDropRight:()=>u("🤍"),metadata:e.metadata,pushAnimation:A===0?"pop":"none",is_reported:!!e.report_idx})}),A+=re)}).catch(g=>console.error(g)).finally(()=>b=!1)}function fe(){for(let s=0;s<Se;s++)ue(s)}function ue(s,o){const a=new Ce({id:s,element:ze(s),stopEvent:!1,positioning:"center-center",position:o,className:"overlay-dot-container"});k.addOverlay(a),x.push(a)}fe(),pe(()=>{k.on("moveend",B),R.on("removeDotByIdx",s=>{F(N,r=(r==null?void 0:r.filter(o=>o.idx!==s))??null,r),x.forEach(o=>{o.get("idx")===s&&(o.set("idx",void 0),o.setPosition(void 0))})})});function B(){const s=k.getView().getZoom();if(!s)return;const o=k.getView().calculateExtent(k.getSize()),a=[];x.forEach(e=>{e.set("uncheck",!0);const u=e.getPosition();(!u||!T(o,u))&&a.push(e)});const c=[],g=Math.ceil(s),m=(r==null?void 0:r.filter(e=>T(o,[e.x,e.y])))??[];P.forEachTileCoord(o,g,e=>{let u=!0;const t=P.getTileCoordExtent(e),i=m.find(d=>T(t,[d.x,d.y])),l=[];if(i){const d=x.find(n=>n.get("idx")===i.idx);if(d)d.set("uncheck",!1),l.push(d),u=!1;else{const n=a.pop();n&&(l.push(n),n.setPosition([i.x,i.y]),n.set("idx",i.idx),n.set("ownerIdx",i.ownerIdx),n.set("uncheck",!1),n.set("reverse-z",1),Q(n,i,JSON.stringify(e)),u=!1)}}x.filter(d=>{if(l.some(v=>v.get("idx")===d.get("idx")))return!1;const n=d.getPosition();return n?T(t,n):!1}).sort((d,n)=>(n.get("reverse-z")??0)-(d.get("reverse-z")??1)).forEach((d,n)=>{const v=d.getPosition();G!=="moon"&&n===0&&!Y(v,l)?(d.set("uncheck",!1),u=!1):(d.set("idx",void 0),d.setPosition(void 0))}),u&&c.push(e)}),G!=="moon"&&c.forEach(e=>{const u=P.getTileCoordExtent(e),[t,i,l]=e;let d=!1;if(h[t]?h[t][i]?h[t][i][l]?d=!0:h[t][i][l]=[]:h[t][i]={[l]:[]}:h[t]={[i]:{[l]:[]}},d){if(h[t][i][l].length===0)return;const n=[];for(const v of h[t][i][l]){const L=x.find(S=>S.get("idx")===v.idx);if(L){L.set("uncheck",!1);return}n.push(v);break}if(n.length===0)return;X(n,u,e);return}fetch(`${$}/posts/dots/${t}/${i}/${l}`,{headers:{Authorization:`Bearer ${p}`,"x-api-version":q.DOTS}}).then(n=>n.json()).then(n=>{const v=h[t][i][l];n.data.forEach(S=>{if(v.some(xe=>xe.idx===S.idx))return;const he=oe(S.score),ge={...S,ownerIdx:S.owner_idx,image:V(S.image_url),size:he};v.push(ge)}),h[t][i][l]=v,v.length!==0&&X([v[0]],u,e)}).catch(n=>console.error(n))})}function X(s,o,a){const[c,g,m]=a,e=x.filter(t=>t.get("uncheck")),u=x.filter(t=>!t.get("uncheck"));s.forEach((t,i)=>{const l=e[i];if(!l)return;const d=[t.x,t.y];Y(d,u)||(u.push(l),l.setPosition(d),l.set("idx",t.idx),l.set("ownerIdx",t.ownerIdx),l.set("uncheck",!1),l.set("reverse-z",1/c),Q(l,t,JSON.stringify(a)))}),x.forEach(t=>{if(t.get("uncheck")!==!0)return;const i=t.getPosition();i&&T(o,i)&&(t.set("idx",void 0),t.set("uncheck",!1),t.setPosition(void 0))})}function Y(s,o,a=226){const c=k.getPixelFromCoordinate(s);return o.some(g=>{const m=g.getPosition();if(!m)return!1;const e=k.getPixelFromCoordinate(m),u=c[0]-e[0],t=c[1]-e[1];return Math.sqrt(u*u+t*t)<a})}function K(s){var g,m;const o=(m=(g=s.currentTarget)==null?void 0:g.dataset)==null?void 0:m.coord;if(!o)return;const a=JSON.parse(o);C(0,E=a);const c=P.getTileCoordExtent(a);r==null||r.forEach(e=>{T(c,[e.x,e.y])&&R.emit("unshiftCard",{idx:e.idx,type:"photo",ownerIdx:e.ownerIdx,image:e.image,emoji:e.emojis,back:e.text,metadata:e.metadata,pushAnimation:"none"})})}function Q(s,o,a){const c=s.getElement();if(!c)return;const g=c.querySelector("img");g&&g.setAttribute("src",o.image);const m=c.querySelector("textPath");m&&(m.innerHTML=o.emojis),c.className=`dot-emoji ${o.size}`,c.removeEventListener("click",K),c.dataset.coord=a,c.addEventListener("click",K)}return ve(()=>{k.un("moveend",B),le(),ce(),de()}),_.$$.update=()=>{_.$$.dirty&1&&(E?U(E):(A=0,J.set(!0),ee.set(!0),H.set(!0),te.set(!1)))},[E]}class $e extends ie{constructor(f){super(),ae(this,f,be,null,ne,{})}}export{$e as D};
