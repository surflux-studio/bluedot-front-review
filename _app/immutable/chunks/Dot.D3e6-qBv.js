import{s as re,k as R,B as T,C as ie,D as ae}from"./scheduler.CGPrvQej.js";import{S as ce,i as le}from"./index.C24WiM7b.js";import{c as fe,m as p,a as w,O as de}from"./map.B2jbmDya.js";import{s as P,c as j,d as ue,A,e as N,f as he,g as B,a as xe,h as Z,b as U}from"./store.Cqlim9q2.js";import{g as me,a as ge}from"./sign.CWFXCZ4p.js";import{e as G}from"./emitter.E5P-NQ8u.js";import{g as X}from"./overlay.D2uvO7-w.js";import{s as L}from"./s32cloudfront.DiPTtnhl.js";let ve=50;const Y=10;function ye(v=0){const k=document.createElement("div");return k.innerHTML=`<img class="dot-avatar" />
    <svg class="dot-spining-emoji" viewBox="0 0 100 100">
      <defs>
        <filter id="shadow-${v}">
          <feDropShadow
            dx="2"
            dy="2"
            stdDeviation="3"
            flood-color="#000000"
            flood-opacity="0.14"
          />
        </filter>
      </defs>
      <path
        id="text-path"
        d="M 50,50 m -30,0 a 30,30 0 1,1 60,0 a 30,30 0 1,1 -60,0"
        fill="none"
      />
      <text font-size="12" dy="-3" letter-spacing="10" filter="url(#shadow-${v})">
        <textPath href="#text-path" startOffset="0">
        </textPath>
      </text>
    </svg>
    `,k}function pe(v,k,O){let f,$;R(v,P,t=>O(7,f=t)),R(v,j,t=>O(8,$=t));let C=null,I=null;const S=fe(),g={},x=[];let y=null,b=!1,_=0;const K=ue.subscribe(t=>{if(t){if(f)return;C=me(),I=ge(),fetch(`${A}/posts/dots/my`,{headers:{Authorization:`Bearer ${C}`,"x-api-version":N.DOTS}}).then(s=>s.json()).then(s=>{const r=s.data;T(P,f=r.map(i=>({...i,ownerIdx:i.owner_idx,image:L(i.image_url),size:X(i.score)})),f),z()})}else C=null,f&&(x.forEach(s=>{s.get("ownerIdx")===`${I}`&&(s.set("idx",void 0),s.setPosition(void 0))}),T(P,f=null,f),I=null)});let D="sun";const Q=he.subscribe(t=>{D=t,z()}),W=B.subscribe(t=>{t?x.forEach(s=>{const r=s.getElement();r&&(r.style.display="flex")}):x.forEach(s=>{const r=s.getElement();r&&(r.style.display="none")})});xe.subscribe(t=>{y&&(t.length>0&&$&&(j.set(!1),Z.set(!1),B.set(!1),U.set(!0)),t.length===5&&y&&!b&&q(y),t.length===0&&O(0,y=null))});function q(t){b=!0;const[s,r,i]=t;fetch(`${A}/posts/dots/${s}/${r}/${i}?offset=${_}&limit=${Y}`,{headers:{"x-api-version":N.DOTS}}).then(u=>u.json()).then(u=>{const h=u.data;h.length!==0&&(h.forEach(e=>{f!=null&&f.some(d=>d.idx===e.idx)||G.emit("unshiftCard",{idx:e.idx,type:"photo",ownerIdx:e.owner_idx,image:L(e.image_url),emoji:e.emojis,back:e.text,metadata:e.metadata,pushAnimation:"none"})}),_+=Y)}).catch(u=>console.error(u)).finally(()=>b=!1)}function ee(){for(let t=0;t<ve;t++)te(t)}function te(t,s){const r=new de({id:t,element:ye(t),stopEvent:!1,positioning:"center-center",position:s,className:"overlay-dot-container"});p.addOverlay(r),x.push(r)}ee(),ie(()=>{p.on("moveend",z),G.on("removeDotByIdx",t=>{T(P,f=(f==null?void 0:f.filter(s=>s.idx!==t))??null,f),x.forEach(s=>{s.get("idx")===t&&(s.set("idx",void 0),s.setPosition(void 0))})})});function z(){const t=p.getView().getZoom();if(!t)return;const s=p.getView().calculateExtent(p.getSize()),r=[];x.forEach(e=>{e.set("uncheck",!0);const d=e.getPosition();(!d||!w(s,d))&&r.push(e)});const i=[],u=Math.ceil(t),h=(f==null?void 0:f.filter(e=>w(s,[e.x,e.y])))??[];S.forEachTileCoord(s,u,e=>{let d=!0;const n=S.getTileCoordExtent(e),a=h.find(l=>w(n,[l.x,l.y])),c=[];if(a){const l=x.find(o=>o.get("idx")===a.idx);if(l)l.set("uncheck",!1),c.push(l),d=!1;else{const o=r.pop();o&&(c.push(o),o.setPosition([a.x,a.y]),o.set("idx",a.idx),o.set("ownerIdx",a.ownerIdx),o.set("uncheck",!1),o.set("reverse-z",1),H(o,a,JSON.stringify(e)),d=!1)}}x.filter(l=>{if(c.some(m=>m.get("idx")===l.get("idx")))return!1;const o=l.getPosition();return o?w(n,o):!1}).sort((l,o)=>(o.get("reverse-z")??0)-(l.get("reverse-z")??1)).forEach((l,o)=>{const m=l.getPosition();D!=="moon"&&o===0&&!V(m,c)?(l.set("uncheck",!1),d=!1):(l.set("idx",void 0),l.setPosition(void 0))}),d&&i.push(e)}),D!=="moon"&&i.forEach(e=>{const d=S.getTileCoordExtent(e),[n,a,c]=e;let l=!1;if(g[n]?g[n][a]?g[n][a][c]?l=!0:g[n][a][c]=[]:g[n][a]={[c]:[]}:g[n]={[a]:{[c]:[]}},l){if(g[n][a][c].length===0)return;const o=[];for(const m of g[n][a][c]){const M=x.find(E=>E.get("idx")===m.idx);if(M){M.set("uncheck",!1);return}o.push(m);break}if(o.length===0)return;J(o,d,e);return}fetch(`${A}/posts/dots/${n}/${a}/${c}`,{headers:{Authorization:`Bearer ${C}`,"x-api-version":N.DOTS}}).then(o=>o.json()).then(o=>{const m=g[n][a][c];o.data.forEach(E=>{if(m.some(oe=>oe.idx===E.idx))return;const se=X(E.score),ne={...E,ownerIdx:E.owner_idx,image:L(E.image_url),size:se};m.push(ne)}),g[n][a][c]=m,m.length!==0&&J([m[0]],d,e)}).catch(o=>console.error(o))})}function J(t,s,r){const[i,u,h]=r,e=x.filter(n=>n.get("uncheck")),d=x.filter(n=>!n.get("uncheck"));t.forEach((n,a)=>{const c=e[a];if(!c)return;const l=[n.x,n.y];V(l,d)||(d.push(c),c.setPosition(l),c.set("idx",n.idx),c.set("ownerIdx",n.ownerIdx),c.set("uncheck",!1),c.set("reverse-z",1/i),H(c,n,JSON.stringify(r)))}),x.forEach(n=>{if(n.get("uncheck")!==!0)return;const a=n.getPosition();a&&w(s,a)&&(n.set("idx",void 0),n.set("uncheck",!1),n.setPosition(void 0))})}function V(t,s,r=226){const i=p.getPixelFromCoordinate(t);return s.some(u=>{const h=u.getPosition();if(!h)return!1;const e=p.getPixelFromCoordinate(h),d=i[0]-e[0],n=i[1]-e[1];return Math.sqrt(d*d+n*n)<r})}function F(t){var u,h;const s=(h=(u=t.currentTarget)==null?void 0:u.dataset)==null?void 0:h.coord;if(!s)return;const r=JSON.parse(s);O(0,y=r);const i=S.getTileCoordExtent(r);f==null||f.forEach(e=>{w(i,[e.x,e.y])&&G.emit("unshiftCard",{idx:e.idx,type:"photo",ownerIdx:e.ownerIdx,image:e.image,emoji:e.emojis,back:e.text,metadata:e.metadata,pushAnimation:"none"})})}function H(t,s,r){const i=t.getElement();if(!i)return;const u=i.querySelector("img");u&&u.setAttribute("src",s.image);const h=i.querySelector("textPath");h&&(h.innerHTML=s.emojis),i.className=`dot-emoji ${s.size}`,i.removeEventListener("click",F),i.dataset.coord=r,i.addEventListener("click",F)}return ae(()=>{p.un("moveend",z),Q(),K(),W()}),v.$$.update=()=>{v.$$.dirty&1&&(y?q(y):(_=0,j.set(!0),Z.set(!0),B.set(!0),U.set(!1)))},[y]}class Ie extends ce{constructor(k){super(),le(this,k,pe,null,re,{})}}export{Ie as D};
