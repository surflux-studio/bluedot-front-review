import"./entry.hzB1vHVB.js";import{F as w,t as f,h as y}from"./heic2any.B8jw32R6.js";import{i as I,e as v,A as E}from"./units.J-uEF215.js";import{s as p,a as u}from"./store.Dw3K1nE2.js";import{g as P}from"./searchParams.gYlq6Cb8.js";const D=async()=>{try{return(await w.pickMedia({limit:1})).files[0]}catch(i){throw i}},R=async(i,n)=>{if(!I()){v.emit("showSignInModal",{removable:!0});return}p.set([]),u.set(!1);const t=document.createElement("input");t.type="file",t.multiple=!0,t.style.display="none",t.accept="image/*,.heic,.heif",document.body.appendChild(t),t.addEventListener("change",async s=>{const r=s.target.files,d=new FormData,l=[];if(r&&r.length>0){for await(const e of Array.from(r)){let o=e,c,m={gps:{longitude:0,latitude:0},exif:null};try{c=await f.gps(e),c&&(m.gps={longitude:c.longitude,latitude:c.latitude});const a=await f.parse(e);a&&(m.exif=a)}catch(a){console.error("메타데이터 추출 오류:",a)}if(e.type==="image/heic"||e.type==="image/heif"||e.name.endsWith(".heic")||e.name.endsWith(".heif"))try{const a=await y({blob:e,toType:"image/jpeg",quality:.9});o=new File([a],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg",lastModified:e.lastModified})}catch(a){console.error("HEIC를 JPEG로 변환하는 중 오류 발생:",a);continue}else try{const a=await b(e);o=new File([a],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg",lastModified:e.lastModified})}catch(a){console.error("이미지를 JPEG로 변환하는 중 오류 발생:",a);continue}console.log("converted done"),d.append("media",o),l.push(m),await A(o).then(a=>{p.update(h=>[...h,a])})}d.append("metadata",JSON.stringify(l)),P("/viewer/edit",{type:"post",placeIdx:String(i),placeName:n},{replaceState:!1,invalidateAll:!1}),fetch(`${E}/posts/media`,{method:"POST",body:d,headers:{Authorization:"Bearer "+window.sessionStorage.getItem("jwt")}}).then(async e=>{const o=await e.json();p.set(o.data.media),u.set(!0)})}document.body.removeChild(t)}),t.click()};async function b(i){return new Promise((n,t)=>{const s=new FileReader;s.onload=g=>{var d;const r=new Image;r.onload=()=>{const l=document.createElement("canvas");l.width=r.width,l.height=r.height;const e=l.getContext("2d");if(!e){t(new Error("캔버스 컨텍스트를 가져올 수 없습니다."));return}e.drawImage(r,0,0),l.toBlob(o=>{o?n(o):t(new Error("캔버스가 비어 있습니다."))},"image/jpeg",.9)},r.onerror=()=>{t(new Error("이미지를 로드하는 데 실패했습니다."))},r.src=(d=g.target)==null?void 0:d.result},s.onerror=()=>{t(new Error("파일을 읽는 데 실패했습니다."))},s.readAsDataURL(i)})}function A(i){const n=new FileReader;return new Promise((t,s)=>{n.onload=()=>{t(n.result)},n.onerror=s,n.readAsDataURL(i)})}export{R as a,D as g};
