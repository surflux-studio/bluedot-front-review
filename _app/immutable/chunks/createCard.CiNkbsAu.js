import{g as u,a as f}from"./sign.CWFXCZ4p.js";import{e as s}from"./emitter.E5P-NQ8u.js";import{i as h,A as w,e as y,s as p,k as b,a as I}from"./store.Cqlim9q2.js";import{C as v,F as D,t as j,h as C}from"./full.esm.DfoHDTgh.js";import{f as U}from"./map.B2jbmDya.js";import{R as _}from"./scheduler.CGPrvQej.js";import{s as l}from"./s32cloudfront.DiPTtnhl.js";import{g}from"./overlay.D2uvO7-w.js";async function k(n){return new Promise((o,r)=>{const a=new Image;a.onload=()=>{const t=document.createElement("canvas");let i=a.width,e=a.height;i>e?i>1280&&(e=Math.round(e*1280/i),i=1280):e>720&&(i=Math.round(i*720/e),e=720),t.width=i,t.height=e;const d=t.getContext("2d");if(!d){r(new Error("Canvas context not available"));return}d.drawImage(a,0,0,i,e),o(t.toDataURL("image/jpeg",.9))},a.onerror=()=>r(new Error("Failed to load image")),a.src=n})}async function P(n){const o=await fetch(n).then(a=>a.blob()),r=await C({blob:o,toType:"image/jpeg",quality:.9});return new Promise(a=>{const t=new FileReader;t.onloadend=()=>a(t.result),t.readAsDataURL(r)})}async function T(){if(h){const e=await v.requestPermissions({permissions:["photos"]});if(e.photos!=="granted"&&e.photos!=="limited")throw s.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const n=(await D.pickImages({readData:!0,limit:1})).files;if(n.length===0)throw new Error("No images selected");const o=n[0];if(!o.data)throw new Error("No image data");const r=await j.parse(o.data),a=r.latitude,t=r.longitude;if(a&&t){const e=U([t,a]);s.emit("flyTo",e),r.x=Math.round(e[0]),r.y=Math.round(e[1])}let i=`data:${o.mimeType};base64,${o.data}`;return(o.mimeType==="image/heic"||o.mimeType==="image/heif")&&(i=await P(i)),{base64Url:i,metadata:r}}async function E(n){n=await k(n);const r=await(await fetch(n)).blob();return new File([r],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function x(n,o,r="private",a){const t=new FormData;t.append("image",n),t.append("emojis",o),t.append("visibility",r),a.x&&a.y&&t.append("location",JSON.stringify({x:a.x,y:a.y})),t.append("metadata",JSON.stringify(a));const i=await fetch(`${w}/posts/dots`,{method:"POST",headers:{"x-api-version":y.DOTS,Authorization:`Bearer ${u()}`},body:t}),e=await i.json();if(!i.ok)throw new Error(e.message||"Failed to create dot");return e.data}function F(){return typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const o=crypto.getRandomValues(new Uint8Array(1))[0]&15;return(n==="x"?o:o&3|8).toString(16)})}async function z(){const n=u();let o="",r={},a=null,t=null;if(!n){s.emit("pushCard",{idx:"111",type:"signIn",unflippable:!0});return}let i=F();s.emit("pushCard",{idx:i,type:"photo",unflippable:!0,ownerIdx:String(f()),image:"/graydot.png",emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",onDumpLeft:async()=>{s.emit("loading",!0);const e=await x(a,(t==null?void 0:t.type)==="photo"?t.emoji:"","private",r);s.emit("loading",!1);const d=l(e.image_url);s.emit("pushCard",{idx:e.idx,ownerIdx:e.owner_idx,type:"photo",image:d,emoji:e.emojis,back:e.text,metadata:e.metadata}),p.update(m=>{const c={...e,ownerIdx:e.owner_idx,image:d,size:g(e.score)};return m?m.push(c):m=[c],m})},right:"모두가 볼 수 있게 남겨요",onDumpRight:async()=>{s.emit("loading",!0);const e=await x(a,(t==null?void 0:t.type)==="photo"?t.emoji:"","public",r);s.emit("loading",!1);const d=l(e.image_url);s.emit("pushCard",{idx:e.idx,ownerIdx:e.owner_idx,type:"photo",image:d,emoji:e.emojis,back:e.text,metadata:e.metadata}),p.update(m=>{const c={...e,ownerIdx:e.owner_idx,image:d,size:g(e.score)};return m?m.push(c):m=[c],m})},rightColor:"positive",onLoad:async()=>{try{const{base64Url:e,metadata:d}=await T();if(o=e,r=d,o.length===0)throw new Error("No images selected")}catch{s.emit("removeCardByIdx",{idx:i}),s.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}s.emit("setCardByIdx",{idx:i,card:{image:o}}),b.set({isOpen:!0,type:"emoji"}),a=await E(o),t=_(I).find(e=>e.idx===i)}})}export{z as c};
