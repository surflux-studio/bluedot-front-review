import{s as N,l as k,e as O,c as q,b as z,f as I,o as S,N as M,i as R,H as W,p as U,u as X,q as F,r as Z,v as H,k as J,O as K,P as Q,y as $}from"./scheduler.BR3E31gO.js";import{S as ee,i as te,t as ne,a as oe}from"./index.CLCQhgPb.js";import{s as D,m as f,t as _,f as T,b as ae}from"./map.CJqEGGTB.js";import{e as P}from"./emitter.E5P-NQ8u.js";import{A as B,c as V}from"./store.CfYlYVHb.js";import{p as se}from"./stores.iud1D4Xb.js";import{g as re}from"./entry.C4HBCcIs.js";import{s as ie}from"./searchParams.C5CztV_9.js";import{s as y}from"./s32cloudfront.COgcnhX7.js";async function le(e,t={},s,r){const m=s||new AbortController;let c;try{return await fetch(e.href,{...t,signal:m.signal})}catch(o){throw o.name==="AbortError"&&console.error("Request timed out"),o}}async function ce({tags:e,bbox:t,abortController:s,offset:r=0,limit:m=100}){const c=new URL(`${B}/embeddings/explore`);c.searchParams.append("tags",e),c.searchParams.append("bbox",t),r&&c.searchParams.append("offset",String(r)),m&&c.searchParams.append("limit",String(m));try{return(await(await le(c,{headers:{"x-api-version":V.EMBEDDING}},s||void 0)).json()).data}catch(o){return o!=="new request"&&console.error(o),[]}}function ue(e,t=500,s=10){let r,m,c;const o=u=>{if("TouchEvent"in window&&u instanceof TouchEvent&&u.touches.length>=2)return clearTimeout(r);const{clientX:E,clientY:g}=u instanceof MouseEvent?u:u.touches[0];m=E,c=g,r=setTimeout(()=>{e.dispatchEvent(new CustomEvent("longpress",{detail:u}))},t)},a=u=>{if("TouchEvent"in window&&u instanceof TouchEvent&&u.touches.length>=2)return clearTimeout(r);const{clientX:E,clientY:g}=u instanceof MouseEvent?u:u.touches[0],w=Math.abs(E-m),C=Math.abs(g-c);(w>s||C>s)&&clearTimeout(r)},l=()=>{clearTimeout(r)};return e.addEventListener("mousedown",o),e.addEventListener("mousemove",a),e.addEventListener("mouseup",l),e.addEventListener("mouseleave",l),e.addEventListener("touchstart",o),e.addEventListener("touchmove",a),e.addEventListener("touchend",l),e.addEventListener("touchcancel",l),{destroy(){e.removeEventListener("mousedown",o),e.removeEventListener("mousemove",a),e.removeEventListener("mouseup",l),e.removeEventListener("mouseleave",l),e.removeEventListener("touchstart",o),e.removeEventListener("touchmove",a),e.removeEventListener("touchend",l),e.removeEventListener("touchcancel",l)}}}async function me(e){try{const s=(await fetch(e,{method:"HEAD"})).headers.get("Content-Type");return s?s.startsWith("video/"):!1}catch(t){return console.error("Error checking file type:",t),!1}}function de(e){let t,s,r,m;const c=e[8].default,o=k(c,e,e[7],null);return{c(){t=O("div"),o&&o.c(),this.h()},l(a){t=q(a,"DIV",{id:!0,class:!0});var l=z(t);o&&o.l(l),l.forEach(I),this.h()},h(){S(t,"id","map"),S(t,"class","absolute w-full h-full z-[1] bg-[#BDDBF3] transition-transform duration-500"),M(t,"transform",`translateY(${e[1]}px)`)},m(a,l){R(a,t,l),o&&o.m(t,null),e[9](t),s=!0,r||(m=[W(ue.call(null,t,500)),U(t,"longpress",e[10])],r=!0)},p(a,[l]){o&&o.p&&(!s||l&128)&&X(o,c,a,a[7],s?Z(c,a[7],l,null):F(a[7]),null),l&2&&M(t,"transform",`translateY(${a[1]}px)`)},i(a){s||(ne(o,a),s=!0)},o(a){oe(o,a),s=!1},d(a){a&&I(t),o&&o.d(a),e[9](null),r=!1,H(m)}}}function A(e){e.preventDefault()}function fe(e,t,s){let r;J(e,se,n=>s(5,r=n));let{$$slots:m={},$$scope:c}=t,{onSelect:o=()=>{}}=t,{onMoveend:a=()=>{}}=t,{mapY:l=0}=t,{allowEdit:u=!0}=t,{whenCancelEdit:E=()=>{}}=t;D.refresh(),P.on("explorePlaces",C);let g="",w;async function C(){var n;if(!(f.getView().getZoom()<16))try{w&&w.abort("new request");const i=(n=window.location.search.split("tags=")[1])==null?void 0:n.split("&")[0];if(!i)return;const d=decodeURIComponent(i);if(!d)return;g!==d&&(D.refresh(),g=d),w=new AbortController;const h=await ce({tags:g,bbox:_(f.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join(),abortController:w});P.emit("addIcons",h.map(p=>({idx:p.idx,coordinate:T(p.location.replace("POINT(","").replace(")","").split(" ").map(Number)),image:y(p.thumbnail,500)||"",shape:"point",type:"place",link:`/places/${p.idx}`,rank:3,name:p.name,width:38,height:46,onlyMain:!0})))}catch(i){(i==null?void 0:i.name)==="AbortError"?console.log("이전 explorePlaces 요청이 취소되었습니다."):console.error("explorePlaces 중 에러 발생:",i)}}f.on("moveend",L);function L(){var n,i;C(),ie({location:((n=f.getView().getCenter())==null?void 0:n.join(","))??"",zoom:((i=f.getView().getZoom())==null?void 0:i.toFixed(2))??""}),a(_(f.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join())}C();let b;K(()=>{f.setTarget(b),b.addEventListener("contextmenu",A),r.url.searchParams.has("location")&&Y(),r.url.searchParams.has("placeIdx")&&x(r.url.searchParams.get("placeIdx")),a(_(f.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join())}),Q(()=>{f.un("moveend",L),b.removeEventListener("contextmenu",A)});function Y(){const n=r.url.searchParams.get("location"),i=r.url.searchParams.get("zoom"),d=n==null?void 0:n.split(",").map(Number),h={};d&&(h.center=d),i&&(h.zoom=Number(i)),Object.values(h).length>0&&ae(h)}P.on("addIconByPlaceIdx",x);async function x(n){var p;const i=await fetch(`${B}/places/${n}`,{headers:{"x-api-version":V.PLACE}}).then(v=>v.json()).then(v=>v.data.place).catch(v=>{console.error(v)});let d=((p=i.thumbnail)==null?void 0:p.at(0))||"";if(!String(d).includes("youtu")){const v=y(d);await me(v)&&(d=d+"-thumbnail")}const h={idx:i.placeIdx,coordinate:T([i.longitude,i.latitude]),image:y(d,500)||"",shape:"point",type:"place",link:`/places/${i.placeIdx}`,rank:5,name:i.name,width:38,height:46};P.emit("addIcon",h)}function j(n){$[n?"unshift":"push"](()=>{b=n,s(4,b)})}const G=n=>{if(!u)return E();if(!r.url.pathname.startsWith("/map"))return;const i=f.getEventCoordinate(n.detail);r.url.pathname!=="/map/edit"?re(`/map/edit?location=${i.join()}`):o(i)};return e.$$set=n=>{"onSelect"in n&&s(0,o=n.onSelect),"onMoveend"in n&&s(6,a=n.onMoveend),"mapY"in n&&s(1,l=n.mapY),"allowEdit"in n&&s(2,u=n.allowEdit),"whenCancelEdit"in n&&s(3,E=n.whenCancelEdit),"$$scope"in n&&s(7,c=n.$$scope)},[o,l,u,E,b,r,a,c,m,j,G]}class ye extends ee{constructor(t){super(),te(this,t,fe,de,N,{onSelect:0,onMoveend:6,mapY:1,allowEdit:2,whenCancelEdit:3})}}export{ye as M};
