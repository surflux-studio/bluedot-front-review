import"./entry.yNG3hslh.js";import{F as y,t as h,h as I}from"./heic2any.C8pgZpIJ.js";import{i as E,e as w,s as m,a as g,A as b}from"./Header.q6v80JDx.js";import{g as F}from"./searchParams.373yhCRv.js";const M=async()=>{try{return(await y.pickMedia({limit:1})).files[0]}catch(t){throw t}},v=async t=>{let a;if(t.type==="image/heic"||t.type==="image/heif"||t.name.endsWith(".heic")||t.name.endsWith(".heif")||t.name.endsWith(".HEIC")||t.name.endsWith(".HEIF")){console.log("HEIC/HEIF 이미지를 JPEG로 변환합니다.");try{const e=await I({blob:t,toType:"image/jpeg",quality:.9});a=new File([e],t.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg",lastModified:t.lastModified})}catch(e){throw console.error("HEIC를 JPEG로 변환하는 중 오류 발생:",e),e}}else{console.log("다른 이미지 형식을 JPEG로 변환합니다.");try{const e=await P(t);a=new File([e],t.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg",lastModified:t.lastModified})}catch(e){throw console.error("이미지를 JPEG로 변환하는 중 오류 발생:",e),e}}return a},B=async(t,a)=>{if(!E()){w.emit("showSignInModal",{removable:!0});return}m.set([]),g.set(!1);const e=document.createElement("input");e.type="file",e.multiple=!0,e.style.display="none",e.accept="image/*,.heic,.heif",document.body.appendChild(e),e.addEventListener("change",async s=>{const r=s.target.files,c=new FormData,i=[];if(r&&r.length>0){for await(const o of Array.from(r)){let n,l={gps:{longitude:0,latitude:0},exif:null};try{n=await h.gps(o),n&&(l.gps={longitude:n.longitude,latitude:n.latitude});const d=await h.parse(o);d&&(l.exif=d)}catch(d){console.error("메타데이터 추출 오류:",d)}const u=await v(o);console.log("converted done"),c.append("media",u),i.push(l),await S(u).then(d=>{m.update(f=>[...f,d])})}c.append("metadata",JSON.stringify(i)),F("/viewer/edit",{type:"post",placeIdx:String(t),placeName:a},{replaceState:!1,invalidateAll:!1}),fetch(`${b}/posts/media`,{method:"POST",body:c,headers:{Authorization:"Bearer "+window.sessionStorage.getItem("jwt")}}).then(async o=>{const n=await o.json();m.set(n.data.media),g.set(!0)}).catch(o=>{console.error("S3 업로드 중 오류 발생:",o),w.emit("pushSnackbar",{message:"사진 업로드 중 오류가 발생했습니다.",buttonText:"뒤로",keep:!0,urgent:!0,uuid:"upload-error",callback:()=>{history.back()}}),g.set(!1)})}document.body.removeChild(e)}),e.click()};async function P(t){if(!(t instanceof Blob))throw new Error("전달된 인자가 File/Blob 타입이 아닙니다.");return new Promise((a,e)=>{const s=new FileReader;s.onload=p=>{var c;const r=new Image;r.onload=()=>{const i=document.createElement("canvas");i.width=r.width,i.height=r.height;const o=i.getContext("2d");if(!o){e(new Error("캔버스 컨텍스트를 가져올 수 없습니다."));return}o.drawImage(r,0,0),i.toBlob(n=>{n?a(n):e(new Error("캔버스가 비어 있습니다."))},"image/jpeg",.9)},r.onerror=()=>{e(new Error("이미지를 로드하는 데 실패했습니다."))},r.src=(c=p.target)==null?void 0:c.result},s.onerror=()=>{e(new Error("파일을 읽는 데 실패했습니다."))},s.readAsDataURL(t)})}function S(t){const a=new FileReader;return new Promise((e,s)=>{a.onload=()=>{e(a.result)},a.onerror=s,a.readAsDataURL(t)})}export{B as a,M as g};
