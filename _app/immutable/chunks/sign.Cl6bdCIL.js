const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web.DjbGKEhm.js","./store.C3f-MM0q.js","./entry.DpEBOy7L.js","./scheduler.BIy9gGKi.js","./preload-helper.D6kgxu3v.js","./web.DNSJSJ3q.js"])))=>i.map(i=>d[i]);
import{g as l}from"./entry.DpEBOy7L.js";import{_ as S}from"./preload-helper.D6kgxu3v.js";import{r as _,C as b,l as m,m as j,d as P,A as u}from"./store.C3f-MM0q.js";import{e as y}from"./emitter.E5P-NQ8u.js";import{O as v}from"./scheduler.BIy9gGKi.js";const d=_("SocialLogin",{web:()=>S(()=>import("./web.DjbGKEhm.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url).then(e=>new e.SocialLoginWeb)}),h=_("SecureStoragePlugin",{web:()=>S(()=>import("./web.DNSJSJ3q.js"),__vite__mapDeps([5,1,2,3,4]),import.meta.url).then(e=>new e.SecureStoragePluginWeb)}),p=b.getPlatform(),g=p==="ios"||p==="android";async function J(){d.initialize({google:{iOSClientId:"298551622119-6r1e3ji2e6vdioqarf2pg3g6brvd47od.apps.googleusercontent.com",webClientId:"298551622119-gg1fqk381om4384l71ju7ip4857cqbh1.apps.googleusercontent.com"},apple:{}})}async function L(e){var t;if(g){const o=(await d.login({provider:"google",options:{scopes:["email","profile"],forcePrompt:!0}})).result,s=await(await fetch(`${u}/auth/social/user`,{method:"POST",body:JSON.stringify({name:o.profile.name,email:o.profile.email,picture:o.profile.imageUrl,provider:"google",keepSignin:e})})).json();if(!((t=s==null?void 0:s.data)!=null&&t.access))throw y.emit("pushSnackbar",{message:"로그인에 실패했습니다."}),Error("Failed to sign in");f(s.data.access,s.data.refresh)}else if(p==="web"){const r="298551622119-gg1fqk381om4384l71ju7ip4857cqbh1.apps.googleusercontent.com",o=`${u}/auth/oauth/google`,i="email profile",s="code",a=new URL(window.location.href);a.searchParams.set("keepSignin",e.toString());const c=a.toString(),n=new URL("https://accounts.google.com/o/oauth2/v2/auth");n.searchParams.set("response_type",s),n.searchParams.set("client_id",r),n.searchParams.set("redirect_uri",o),n.searchParams.set("scope",i),n.searchParams.set("state",c),n.searchParams.set("prompt","select_account"),location.replace(n)}else throw Error("Not supported platform")}async function N(e){var c;if(p!=="ios")return;const r=(await d.login({provider:"apple",options:{}})).result;let o=r.profile.givenName??"";r.profile.familyName&&(o+=(o?" ":"")+r.profile.familyName);let i=r.profile.email;const a=await(await fetch(`${u}/auth/social/apple`,{method:"POST",body:JSON.stringify({name:o,email:i,providerId:r.profile.user,keepSignin:e})})).json();if(!((c=a==null?void 0:a.data)!=null&&c.access))throw y.emit("pushSnackbar",{message:"로그인에 실패했습니다."}),Error("Failed to sign in");f(a.data.access,a.data.refresh)}function R(){sessionStorage.removeItem("jwt"),g&&h.clear(),P.set(!1)}function I(){try{const e=sessionStorage.getItem("jwt")||null;if(!e)throw new Error("jwt not found");if(v(m)===!0&&!window.location.pathname.startsWith("/users/sign-up/")&&!window.location.pathname.startsWith("/tp/"))return console.log("A"),l("/users/sign-up/agreement"),null;const t=w(e);if(t.exp&&Math.floor(Date.now()/1e3)>t.exp)throw j.set(!0),new Error("jwt expired");return t.sig===!1&&!window.location.pathname.startsWith("/users/sign-up")&&!window.location.pathname.startsWith("/tp")?(m.set(!0),l("/users/sign-up/agreement"),null):e}catch(e){return console.warn(e),sessionStorage.removeItem("jwt"),null}}function k(){const e=I();return e?w(e):null}function C(){const e=k();return e?BigInt(e.sub):null}function f(e,t){sessionStorage.setItem("jwt",e),g&&t&&h.set({key:"refresh",value:t}),P.set(!0)}async function W(){const e={credentials:"include"};if(g)try{const t=await h.get({key:"refresh"});if(!t.value)return!1;e.headers={Authorization:`Bearer ${t.value}`}}catch{return!1}try{const t=await fetch(`${u}/auth/token/refresh`,e);if(!t.ok)throw new Error("Failed to refresh token");const r=await t.json();return f(r.data.access,r.data.refresh),!0}catch{return!1}}async function q(e){const t=e.searchParams.get("access");if(t){f(t);const r=w(t).sig;if(e.searchParams.delete("access"),r===!1){m.set(!0),await l("/users/sign-up/agreement");return}await l(e.toString(),{replaceState:!0,invalidateAll:!1})}}function w(e){const r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),o=decodeURIComponent(atob(r).split("").map(function(i){return"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(o)}function x(){return I()!==null}export{C as a,L as b,N as c,J as d,I as g,q as h,x as i,W as r,R as s};
