import{s as Y,m as z,e as L,c as N,b as F,f as y,v as B,C as D,i as O,E as T,A as W,u as Z,o as q,p as R,F as U,k as H,y as J,B as K,w as Q}from"./scheduler.DnGlJ4RW.js";import{S as X,i as $,t as ee,a as te}from"./index.D2MnZ5yf.js";import{s as V,m,f as ne}from"./map.DnEg6E_3.js";import{e as E}from"./emitter.E5P-NQ8u.js";import{g as oe}from"./search.CkwFGvbl.js";import{p as ae}from"./stores.CjSzvCOb.js";import{l as ie}from"./longPress.C9F0mLoM.js";import{g as se}from"./entry.BUNH8WXy.js";import{s as le}from"./searchParams.cKoutT9R.js";import{a as x,f as A}from"./proj.DXH8zrwl.js";import{A as re}from"./store.H7kP-9hr.js";import{s as I}from"./s32cloudfront.CRsPwdtK.js";import{i as ce}from"./isVideoFile.DGBlGWVm.js";function me(s){let n,i,l,g;const h=s[8].default,a=z(h,s,s[7],null);return{c(){n=L("div"),a&&a.c(),this.h()},l(o){n=N(o,"DIV",{id:!0,class:!0});var c=F(n);a&&a.l(c),c.forEach(y),this.h()},h(){B(n,"id","map"),B(n,"class","absolute w-full h-full z-[1] bg-[#BDDBF3] transition-transform duration-500"),D(n,"transform",`translateY(${s[1]}px)`)},m(o,c){O(o,n,c),a&&a.m(n,null),s[9](n),i=!0,l||(g=[T(ie.call(null,n,500)),W(n,"longpress",s[10])],l=!0)},p(o,[c]){a&&a.p&&(!i||c&128)&&Z(a,h,o,o[7],i?R(h,o[7],c,null):q(o[7]),null),c&2&&D(n,"transform",`translateY(${o[1]}px)`)},i(o){i||(ee(a,o),i=!0)},o(o){te(a,o),i=!1},d(o){o&&y(n),a&&a.d(o),s[9](null),l=!1,U(g)}}}function M(s){s.preventDefault()}function ue(s,n,i){let l;H(s,ae,e=>i(5,l=e));let{$$slots:g={},$$scope:h}=n,{onSelect:a=()=>{}}=n,{onMoveend:o=()=>{}}=n,{mapY:c=0}=n,{allowEdit:_=!0}=n,{whenCancelEdit:b=()=>{}}=n;V.refresh(),E.on("explorePlaces",P);let w="",C;async function P(){var e;if(!(m.getView().getZoom()<16))try{C&&C.abort("new request");const t=(e=window.location.search.split("tags=")[1])==null?void 0:e.split("&")[0];if(!t)return;const r=decodeURIComponent(t);if(!r)return;w!==r&&(V.refresh(),w=r),C=new AbortController;const u=await oe({tags:w,bbox:x(m.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join(),abortController:C});E.emit("addIcons",u.map(f=>({idx:f.idx,coordinate:A(f.location.replace("POINT(","").replace(")","").split(" ").map(Number)),image:I(f.thumbnail,500)||"",shape:"point",type:"place",link:`/places/${f.idx}`,rank:3,name:f.name,width:38,height:46,onlyMain:!0})))}catch(t){(t==null?void 0:t.name)==="AbortError"?console.log("이전 explorePlaces 요청이 취소되었습니다."):console.error("explorePlaces 중 에러 발생:",t)}}m.on("moveend",S);function S(){var e,t;P(),le({location:((e=m.getView().getCenter())==null?void 0:e.join(","))??"",zoom:((t=m.getView().getZoom())==null?void 0:t.toFixed(2))??""}),o(x(m.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join())}P();let p;J(()=>{m.setTarget(p),p.addEventListener("contextmenu",M),l.url.searchParams.has("location")&&j(),l.url.searchParams.has("placeIdx")&&v(l.url.searchParams.get("placeIdx")),o(x(m.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join())}),K(()=>{m.un("moveend",S),p.removeEventListener("contextmenu",M)});function j(){const e=l.url.searchParams.get("location"),t=l.url.searchParams.get("zoom"),r=e==null?void 0:e.split(",").map(Number),u={};r&&(u.center=r),t&&(u.zoom=Number(t)),Object.values(u).length>0&&ne(u)}E.on("addIconByPlaceIdx",v);async function v(e){var f;const t=await fetch(`${re}/places/${e}`).then(d=>d.json()).then(d=>d.data.place).catch(d=>{console.error(d)});let r=((f=t.thumbnail)==null?void 0:f.at(0))||"";if(!String(r).includes("youtu")){const d=I(r);await ce(d)&&(r=r+"-thumbnail")}const u={idx:t.placeIdx,coordinate:A([t.longitude,t.latitude]),image:I(r,500)||"",shape:"point",type:"place",link:`/places/${t.placeIdx}`,rank:5,name:t.name,width:38,height:46};E.emit("addIcon",u)}function G(e){Q[e?"unshift":"push"](()=>{p=e,i(4,p)})}const k=e=>{if(!_)return b();if(!l.url.pathname.startsWith("/map"))return;const t=m.getEventCoordinate(e.detail);l.url.pathname!=="/map/edit"?se(`/map/edit?location=${t.join()}`):a(t)};return s.$$set=e=>{"onSelect"in e&&i(0,a=e.onSelect),"onMoveend"in e&&i(6,o=e.onMoveend),"mapY"in e&&i(1,c=e.mapY),"allowEdit"in e&&i(2,_=e.allowEdit),"whenCancelEdit"in e&&i(3,b=e.whenCancelEdit),"$$scope"in e&&i(7,h=e.$$scope)},[a,c,_,b,p,l,o,h,g,G,k]}class ve extends X{constructor(n){super(),$(this,n,ue,me,Y,{onSelect:0,onMoveend:6,mapY:1,allowEdit:2,whenCancelEdit:3})}}export{ve as M};
