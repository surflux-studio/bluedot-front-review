import{g as l,a as u}from"./sign.CwkvNQMK.js";import{e as s}from"./emitter.E5P-NQ8u.js";import{i as g,A as f,e as h,j as w,a as y,s as b}from"./store.z3rQTxfj.js";import{C as x,F as I,t as D,h as v,g as p}from"./uuid.CUk116Y0.js";import{f as k}from"./map.BIBuOocF.js";import{O as P,E as C}from"./scheduler.BhpXRznE.js";import{s as E}from"./s32cloudfront.Dh2ozjt-.js";import{g as F}from"./overlay.D2uvO7-w.js";async function T(n){return new Promise((r,o)=>{const a=new Image;a.onload=()=>{const i=document.createElement("canvas");let e=a.width,t=a.height;e>t?e>1280&&(t=Math.round(t*1280/e),e=1280):t>720&&(e=Math.round(e*720/t),t=720),i.width=e,i.height=t;const d=i.getContext("2d");if(!d){o(new Error("Canvas context not available"));return}d.drawImage(a,0,0,e,t),r(i.toDataURL("image/jpeg",.9))},a.onerror=()=>o(new Error("Failed to load image")),a.src=n})}async function j(n){const r=await fetch(n).then(a=>a.blob()),o=await v({blob:r,toType:"image/jpeg",quality:.9});return new Promise(a=>{const i=new FileReader;i.onloadend=()=>a(i.result),i.readAsDataURL(o)})}async function A(){if(g){const t=await x.requestPermissions({permissions:["photos"]});if(t.photos!=="granted"&&t.photos!=="limited")throw s.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const n=(await I.pickImages({readData:!0,limit:1})).files;if(n.length===0)throw new Error("No images selected");const r=n[0];if(!r.data)throw new Error("No image data");const o=await D.parse(r.data),a=o.latitude,i=o.longitude;if(a&&i){const t=k([i,a]);s.emit("flyTo",t),o.x=Math.round(t[0]),o.y=Math.round(t[1])}let e=`data:${r.mimeType};base64,${r.data}`;return(r.mimeType==="image/heic"||r.mimeType==="image/heif")&&(e=await j(e)),{base64Url:e,metadata:o}}async function B(n){n=await T(n);const o=await(await fetch(n)).blob();return new File([o],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function O(n,r,o="private",a){const i=new FormData;i.append("image",n),i.append("emojis",r),i.append("visibility",o),a.x&&a.y&&i.append("location",JSON.stringify({x:a.x,y:a.y})),i.append("metadata",JSON.stringify(a));const e=await fetch(`${f}/posts/dots`,{method:"POST",headers:{"x-api-version":h.DOTS,Authorization:`Bearer ${l()}`},body:i}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to create dot");return t.data}async function J(){const n=l();let r="",o={},a=null,i=null;if(!n){s.emit("pushCard",{idx:p(),type:"signIn",unflippable:!0});return}let e=p();s.emit("pushCard",{idx:e,type:"photo",unflippable:!0,ownerIdx:String(u()),image:"/graydot.png",emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",right:"모두가 볼 수 있게 남겨요",rightColor:"positive",unDroppable:!0,onPreDropLeft:async()=>{s.emit("blockWindowEvents",!0),await c(e,a,i,"private",o)},onPreDropRight:async()=>{s.emit("blockWindowEvents",!0),await c(e,a,i,"public",o)},onLoad:async()=>{try{const{base64Url:t,metadata:d}=await A();if(r=t,o=d,r.length===0)throw new Error("No images selected")}catch{s.emit("removeCardByIdx",{idx:e}),s.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}s.emit("setCardByIdx",{idx:e,card:{image:r}}),w.set({isOpen:!0,type:"emoji"}),a=await B(r),i=P(y).find(t=>t.idx===e)}})}async function c(n,r,o,a,i){s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"shake"}});const e=await O(r,(o==null?void 0:o.type)==="photo"?o.emoji:"",a,i),t=E(e.image_url);b.update(d=>{const m={...e,ownerIdx:e.owner_idx,image:t,size:F(e.score)};return d?d.push(m):d=[m],d}),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"none"}}),s.emit("setCardByIdx",{idx:n,card:{image:t,back:e.text,unflippable:!1,onPreDropLeft:()=>{},onPreDropRight:()=>{},unDroppable:!1,left:"",right:""}}),await C(),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"create",pushDuration:4e3,isFlipped:!0}}),s.emit("showFirework"),setTimeout(()=>{s.emit("blockWindowEvents",!1)},4e3)}export{J as c};
