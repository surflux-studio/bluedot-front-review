import{g as c,a as l}from"./sign.C1mBDN6D.js";import{e as s}from"./emitter.E5P-NQ8u.js";import{i as u,A as g,e as f,k as x,a as h,s as w}from"./store.Dsa1BmbC.js";import{C as y,F as b,t as I,h as D}from"./full.esm.DFDleV4Z.js";import{f as v}from"./map.mYok0lVX.js";import{R as k,E as P}from"./scheduler.CGPrvQej.js";import{s as C}from"./s32cloudfront.Be8BhNLx.js";import{g as U}from"./overlay.D2uvO7-w.js";async function E(n){return new Promise((r,i)=>{const a=new Image;a.onload=()=>{const o=document.createElement("canvas");let e=a.width,t=a.height;e>t?e>1280&&(t=Math.round(t*1280/e),e=1280):t>720&&(e=Math.round(e*720/t),t=720),o.width=e,o.height=t;const d=o.getContext("2d");if(!d){i(new Error("Canvas context not available"));return}d.drawImage(a,0,0,e,t),r(o.toDataURL("image/jpeg",.9))},a.onerror=()=>i(new Error("Failed to load image")),a.src=n})}async function A(n){const r=await fetch(n).then(a=>a.blob()),i=await D({blob:r,toType:"image/jpeg",quality:.9});return new Promise(a=>{const o=new FileReader;o.onloadend=()=>a(o.result),o.readAsDataURL(i)})}async function F(){if(u){const t=await y.requestPermissions({permissions:["photos"]});if(t.photos!=="granted"&&t.photos!=="limited")throw s.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const n=(await b.pickImages({readData:!0,limit:1})).files;if(n.length===0)throw new Error("No images selected");const r=n[0];if(!r.data)throw new Error("No image data");const i=await I.parse(r.data),a=i.latitude,o=i.longitude;if(a&&o){const t=v([o,a]);s.emit("flyTo",t),i.x=Math.round(t[0]),i.y=Math.round(t[1])}let e=`data:${r.mimeType};base64,${r.data}`;return(r.mimeType==="image/heic"||r.mimeType==="image/heif")&&(e=await A(e)),{base64Url:e,metadata:i}}async function T(n){n=await E(n);const i=await(await fetch(n)).blob();return new File([i],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function B(n,r,i="private",a){const o=new FormData;o.append("image",n),o.append("emojis",r),o.append("visibility",i),a.x&&a.y&&o.append("location",JSON.stringify({x:a.x,y:a.y})),o.append("metadata",JSON.stringify(a));const e=await fetch(`${g}/posts/dots`,{method:"POST",headers:{"x-api-version":f.DOTS,Authorization:`Bearer ${c()}`},body:o}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to create dot");return t.data}function j(){return typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;return(n==="x"?r:r&3|8).toString(16)})}async function J(){const n=c();let r="",i={},a=null,o=null;if(!n){s.emit("pushCard",{idx:"111",type:"signIn",unflippable:!0});return}let e=j();s.emit("pushCard",{idx:e,type:"photo",unflippable:!0,ownerIdx:String(l()),image:"/graydot.png",emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",right:"모두가 볼 수 있게 남겨요",rightColor:"positive",unDroppable:!0,onPreDropLeft:async()=>{s.emit("blockWindowEvents",!0),await p(e,a,o,"private",i)},onPreDropRight:async()=>{s.emit("blockWindowEvents",!0),await p(e,a,o,"public",i)},onLoad:async()=>{try{const{base64Url:t,metadata:d}=await F();if(r=t,i=d,r.length===0)throw new Error("No images selected")}catch{s.emit("removeCardByIdx",{idx:e}),s.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}s.emit("setCardByIdx",{idx:e,card:{image:r}}),x.set({isOpen:!0,type:"emoji"}),a=await T(r),o=k(h).find(t=>t.idx===e)}})}async function p(n,r,i,a,o){s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"shake"}});const e=await B(r,(i==null?void 0:i.type)==="photo"?i.emoji:"",a,o),t=C(e.image_url);w.update(d=>{const m={...e,ownerIdx:e.owner_idx,image:t,size:U(e.score)};return d?d.push(m):d=[m],d}),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"none"}}),s.emit("setCardByIdx",{idx:n,card:{image:t,back:e.text,unflippable:!1,onPreDropLeft:()=>{},onPreDropRight:()=>{},unDroppable:!1,left:"",right:""}}),await P(),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"create",pushDuration:4e3,isFlipped:!0}}),s.emit("showFirework"),setTimeout(()=>{s.emit("blockWindowEvents",!1)},4e3)}export{J as c};
