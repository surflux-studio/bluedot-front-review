import"./entry.ByILCBPu.js";import{F as y,s as p,a as f,t as h,h as v}from"./heic2any.CtMe41Yr.js";import{i as x,e as E}from"./units.D6cS1jHK.js";import{g as F}from"./searchParams.CqMuYFPd.js";const A=async()=>{try{return(await y.pickMedia({limit:1})).files[0]}catch(i){throw i}},D=async(i,r)=>{if(!x()){E.emit("showSignInModal",{removable:!0});return}p.set([]),f.set(!1);const t=document.createElement("input");t.type="file",t.multiple=!0,t.style.display="none",t.accept="image/*,.heic,.heif",document.body.appendChild(t),t.addEventListener("change",async n=>{const o=n.target.files,l=new FormData,s=[];if(o&&o.length>0){let g="";for await(const e of Array.from(o)){let d=e,c,m={gps:{longitude:0,latitude:0},exif:null};try{c=await h.gps(e),c&&(g=`&location=${c.longitude.toFixed(5)},${c.latitude.toFixed(5)}`,m.gps={longitude:c.longitude,latitude:c.latitude});const a=await h.parse(e);a&&(m.exif=a)}catch(a){console.error("메타데이터 추출 오류:",a)}if(e.type==="image/heic"||e.type==="image/heif"||e.name.endsWith(".heic")||e.name.endsWith(".heif"))try{const a=await v({blob:e,toType:"image/jpeg",quality:.9});d=new File([a],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg",lastModified:e.lastModified})}catch(a){console.error("HEIC를 JPEG로 변환하는 중 오류 발생:",a);continue}else try{const a=await I(e);d=new File([a],e.name.replace(/\.[^/.]+$/,".jpg"),{type:"image/jpeg",lastModified:e.lastModified})}catch(a){console.error("이미지를 JPEG로 변환하는 중 오류 발생:",a);continue}console.log("converted done"),l.append("media",d),s.push(m),await b(d).then(a=>{p.update(w=>[...w,a])})}l.append("metadata",JSON.stringify(s)),F("/viewer/edit",{type:"post",placeIdx:String(i),placeName:r,location:g},{replaceState:!1,invalidateAll:!1}),fetch("https://azit.surflux.studio/posts/media",{method:"POST",body:l,headers:{Authorization:"Bearer "+window.sessionStorage.getItem("jwt")}}).then(async e=>{const d=await e.json();p.set(d.data.media),f.set(!0)})}document.body.removeChild(t)}),t.click()};async function I(i){return new Promise((r,t)=>{const n=new FileReader;n.onload=u=>{var l;const o=new Image;o.onload=()=>{const s=document.createElement("canvas");s.width=o.width,s.height=o.height;const g=s.getContext("2d");if(!g){t(new Error("캔버스 컨텍스트를 가져올 수 없습니다."));return}g.drawImage(o,0,0),s.toBlob(e=>{e?r(e):t(new Error("캔버스가 비어 있습니다."))},"image/jpeg",.9)},o.onerror=()=>{t(new Error("이미지를 로드하는 데 실패했습니다."))},o.src=(l=u.target)==null?void 0:l.result},n.onerror=()=>{t(new Error("파일을 읽는 데 실패했습니다."))},n.readAsDataURL(i)})}function b(i){const r=new FileReader;return new Promise((t,n)=>{r.onload=()=>{t(r.result)},r.onerror=n,r.readAsDataURL(i)})}export{D as a,A as g};
