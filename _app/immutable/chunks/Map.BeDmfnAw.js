import{s as k,l as O,e as R,c as q,b as z,f as x,o as S,P as D,i as U,J as W,p as F,u as X,q as Z,r as H,v as J,k as K,C as Q,D as $,y as ee}from"./scheduler.BIy9gGKi.js";import{S as te,i as ne,t as oe,a as se}from"./index.BETvqhaq.js";import{s as M,m as f,t as P,f as T,b as ae}from"./map.BYhwzbsJ.js";import{e as y}from"./emitter.E5P-NQ8u.js";import{n as A,A as B,e as V}from"./store.D_x_WhgB.js";import{p as ie}from"./stores.Bqu47ygI.js";import{g as re}from"./entry.ChFZqIU1.js";import{s as le}from"./searchParams.BYdg1HuI.js";function ce(e){if(!e||!e.includes("youtu"))return null;let t=null;return e.includes("watch?v=")?t=e.split("watch?v=")[1].split("&")[0]:e.includes("embed")?t=e.split("embed/")[1].split("?")[0]:e.includes("shorts")&&(t=e.split("shorts/")[1].split("?")[0]),t}function ue(e,t="default"){return e.includes("youtu")?`https://img.youtube.com/vi/${ce(e)}/${t}.jpg`:e}function _(e,t){if(!e)return"";if(typeof e!="string"&&(e=e[0]||""),String(e).includes("youtu"))return ue(e,"hqdefault");if(!String(e).includes("bluedot-media"))return e;const s=e.split("/").at(-1);return t?`${A}/resize?key=${s}&side=${t}`:`${A}/${s}`}async function de(e,t={},s,i){const d=s||new AbortController;let c;try{return await fetch(e.href,{...t,signal:d.signal})}catch(o){throw o.name==="AbortError"&&console.error("Request timed out"),o}}async function me({tags:e,bbox:t,abortController:s,offset:i=0,limit:d=100}){const c=new URL(`${B}/embeddings/explore`);c.searchParams.append("tags",e),c.searchParams.append("bbox",t),i&&c.searchParams.append("offset",String(i)),d&&c.searchParams.append("limit",String(d));try{return(await(await de(c,{headers:{"x-api-version":V.EMBEDDING}},s||void 0)).json()).data}catch(o){return o!=="new request"&&console.error(o),[]}}function fe(e,t=500,s=10){let i,d,c;const o=u=>{if("TouchEvent"in window&&u instanceof TouchEvent&&u.touches.length>=2)return clearTimeout(i);const{clientX:g,clientY:E}=u instanceof MouseEvent?u:u.touches[0];d=g,c=E,i=setTimeout(()=>{e.dispatchEvent(new CustomEvent("longpress",{detail:u}))},t)},a=u=>{if("TouchEvent"in window&&u instanceof TouchEvent&&u.touches.length>=2)return clearTimeout(i);const{clientX:g,clientY:E}=u instanceof MouseEvent?u:u.touches[0],b=Math.abs(g-d),C=Math.abs(E-c);(b>s||C>s)&&clearTimeout(i)},l=()=>{clearTimeout(i)};return e.addEventListener("mousedown",o),e.addEventListener("mousemove",a),e.addEventListener("mouseup",l),e.addEventListener("mouseleave",l),e.addEventListener("touchstart",o),e.addEventListener("touchmove",a),e.addEventListener("touchend",l),e.addEventListener("touchcancel",l),{destroy(){e.removeEventListener("mousedown",o),e.removeEventListener("mousemove",a),e.removeEventListener("mouseup",l),e.removeEventListener("mouseleave",l),e.removeEventListener("touchstart",o),e.removeEventListener("touchmove",a),e.removeEventListener("touchend",l),e.removeEventListener("touchcancel",l)}}}async function he(e){try{const s=(await fetch(e,{method:"HEAD"})).headers.get("Content-Type");return s?s.startsWith("video/"):!1}catch(t){return console.error("Error checking file type:",t),!1}}function pe(e){let t,s,i,d;const c=e[8].default,o=O(c,e,e[7],null);return{c(){t=R("div"),o&&o.c(),this.h()},l(a){t=q(a,"DIV",{id:!0,class:!0});var l=z(t);o&&o.l(l),l.forEach(x),this.h()},h(){S(t,"id","map"),S(t,"class","absolute w-full h-full z-[1] bg-[#BDDBF3] transition-transform duration-500"),D(t,"transform",`translateY(${e[1]}px)`)},m(a,l){U(a,t,l),o&&o.m(t,null),e[9](t),s=!0,i||(d=[W(fe.call(null,t,500)),F(t,"longpress",e[10])],i=!0)},p(a,[l]){o&&o.p&&(!s||l&128)&&X(o,c,a,a[7],s?H(c,a[7],l,null):Z(a[7]),null),l&2&&D(t,"transform",`translateY(${a[1]}px)`)},i(a){s||(oe(o,a),s=!0)},o(a){se(o,a),s=!1},d(a){a&&x(t),o&&o.d(a),e[9](null),i=!1,J(d)}}}function Y(e){e.preventDefault()}function ge(e,t,s){let i;K(e,ie,n=>s(5,i=n));let{$$slots:d={},$$scope:c}=t,{onSelect:o=()=>{}}=t,{onMoveend:a=()=>{}}=t,{mapY:l=0}=t,{allowEdit:u=!0}=t,{whenCancelEdit:g=()=>{}}=t;M.refresh(),y.on("explorePlaces",C);let E="",b;async function C(){var n;if(!(f.getView().getZoom()<16))try{b&&b.abort("new request");const r=(n=window.location.search.split("tags=")[1])==null?void 0:n.split("&")[0];if(!r)return;const m=decodeURIComponent(r);if(!m)return;E!==m&&(M.refresh(),E=m),b=new AbortController;const h=await me({tags:E,bbox:P(f.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join(),abortController:b});y.emit("addIcons",h.map(p=>({idx:p.idx,coordinate:T(p.location.replace("POINT(","").replace(")","").split(" ").map(Number)),image:_(p.thumbnail,500)||"",shape:"point",type:"place",link:`/places/${p.idx}`,rank:3,name:p.name,width:38,height:46,onlyMain:!0})))}catch(r){(r==null?void 0:r.name)==="AbortError"?console.log("이전 explorePlaces 요청이 취소되었습니다."):console.error("explorePlaces 중 에러 발생:",r)}}f.on("moveend",I);function I(){var n,r;C(),le({location:((n=f.getView().getCenter())==null?void 0:n.join(","))??"",zoom:((r=f.getView().getZoom())==null?void 0:r.toFixed(2))??""}),a(P(f.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join())}C();let w;Q(()=>{f.setTarget(w),w.addEventListener("contextmenu",Y),i.url.searchParams.has("location")&&j(),i.url.searchParams.has("placeIdx")&&L(i.url.searchParams.get("placeIdx")),a(P(f.getView().calculateExtent(),"EPSG:3857","EPSG:4326").join())}),$(()=>{f.un("moveend",I),w.removeEventListener("contextmenu",Y)});function j(){const n=i.url.searchParams.get("location"),r=i.url.searchParams.get("zoom"),m=n==null?void 0:n.split(",").map(Number),h={};m&&(h.center=m),r&&(h.zoom=Number(r)),Object.values(h).length>0&&ae(h)}y.on("addIconByPlaceIdx",L);async function L(n){var p;const r=await fetch(`${B}/places/${n}`,{headers:{"x-api-version":V.PLACE}}).then(v=>v.json()).then(v=>v.data.place).catch(v=>{console.error(v)});let m=((p=r.thumbnail)==null?void 0:p.at(0))||"";if(!String(m).includes("youtu")){const v=_(m);await he(v)&&(m=m+"-thumbnail")}const h={idx:r.placeIdx,coordinate:T([r.longitude,r.latitude]),image:_(m,500)||"",shape:"point",type:"place",link:`/places/${r.placeIdx}`,rank:5,name:r.name,width:38,height:46};y.emit("addIcon",h)}function G(n){ee[n?"unshift":"push"](()=>{w=n,s(4,w)})}const N=n=>{if(!u)return g();if(!i.url.pathname.startsWith("/map"))return;const r=f.getEventCoordinate(n.detail);i.url.pathname!=="/map/edit"?re(`/map/edit?location=${r.join()}`):o(r)};return e.$$set=n=>{"onSelect"in n&&s(0,o=n.onSelect),"onMoveend"in n&&s(6,a=n.onMoveend),"mapY"in n&&s(1,l=n.mapY),"allowEdit"in n&&s(2,u=n.allowEdit),"whenCancelEdit"in n&&s(3,g=n.whenCancelEdit),"$$scope"in n&&s(7,c=n.$$scope)},[o,l,u,g,w,i,a,c,d,G,N]}class Le extends te{constructor(t){super(),ne(this,t,ge,pe,k,{onSelect:0,onMoveend:6,mapY:1,allowEdit:2,whenCancelEdit:3})}}export{Le as M,_ as s};
