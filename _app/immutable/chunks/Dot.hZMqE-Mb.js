import{s as ie,k as V,B as j,C as ae,D as ce}from"./scheduler.BIy9gGKi.js";import{S as le,i as de}from"./index.BETvqhaq.js";import{c as fe,m as v,a as E,O as ue}from"./map.BYhwzbsJ.js";import{s as z,c as B,d as he,A as P,e as N,f as xe,g as $,a as me,h as H,b as Z}from"./store.D_x_WhgB.js";import{g as X,a as ge}from"./sign.Dd13uTR8.js";import{e as b}from"./emitter.E5P-NQ8u.js";import{g as Y}from"./overlay.D2uvO7-w.js";import{s as G}from"./Map.BeDmfnAw.js";import{g as pe}from"./uuid.BbJUX8XE.js";let ye=50;const K=10;function ve(p=0){const C=document.createElement("div");return C.innerHTML=`<img class="dot-avatar" />
    <svg class="dot-spining-emoji" viewBox="0 0 100 100">
      <defs>
        <filter id="shadow-${p}">
          <feDropShadow
            dx="2"
            dy="2"
            stdDeviation="3"
            flood-color="#000000"
            flood-opacity="0.14"
          />
        </filter>
      </defs>
      <path
        id="text-path"
        d="M 50,50 m -30,0 a 30,30 0 1,1 60,0 a 30,30 0 1,1 -60,0"
        fill="none"
      />
      <text font-size="12" dy="-3" letter-spacing="10" filter="url(#shadow-${p})">
        <textPath href="#text-path" startOffset="0">
        </textPath>
      </text>
    </svg>
    `,C}function we(p,C,O){let d,J;V(p,z,t=>O(7,d=t)),V(p,B,t=>O(8,J=t));let k=null,D=null;const I=fe(),g={},x=[];let y=null,T=!1,_=0;const Q=he.subscribe(t=>{if(t){if(d)return;k=X(),D=ge(),fetch(`${P}/posts/dots/my`,{headers:{Authorization:`Bearer ${k}`,"x-api-version":N.DOTS}}).then(s=>s.json()).then(s=>{const i=s.data;j(z,d=i.map(a=>({...a,ownerIdx:a.owner_idx,image:G(a.image_url),size:Y(a.score)})),d),S()})}else k=null,d&&(x.forEach(s=>{s.get("ownerIdx")===`${D}`&&(s.set("idx",void 0),s.setPosition(void 0))}),j(z,d=null,d),D=null)});let A="sun";const W=xe.subscribe(t=>{A=t,S()}),ee=$.subscribe(t=>{t?x.forEach(s=>{const i=s.getElement();i&&(i.style.display="flex")}):x.forEach(s=>{const i=s.getElement();i&&(i.style.display="none")})});me.subscribe(t=>{y&&(t.length>0&&J&&(B.set(!1),H.set(!1),$.set(!1),Z.set(!0)),t.length===5&&y&&!T&&L(y),t.length===0&&O(0,y=null))});function L(t){T=!0;const[s,i,a]=t;fetch(`${P}/posts/dots/${s}/${i}/${a}?offset=${_}&limit=${K}`,{headers:{Authorization:`Bearer ${k}`,"x-api-version":N.DOTS}}).then(u=>u.json()).then(u=>{const h=u.data;h.length!==0&&(h.forEach(e=>{if(d!=null&&d.some(o=>o.idx===e.idx))return;const f=async()=>{const o=X();return o?(await fetch(`${P}/vote/reactions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({type:"🤍",targetTable:"dots",targetId:e.idx})}),!1):(b.emit("pushCard",{idx:pe(),type:"signIn",pushAnimation:"pop",unflippable:!0}),!0)};b.emit("unshiftCard",{idx:e.idx,type:"photo",ownerIdx:e.owner_idx,image:G(e.image_url),emoji:e.emojis,back:e.text,left:"넘길게요",right:"🤍",rightColor:"positive",onPreDropRight:f,metadata:e.metadata,pushAnimation:"none",is_reported:!!e.report_idx})}),_+=K)}).catch(u=>console.error(u)).finally(()=>T=!1)}function te(){for(let t=0;t<ye;t++)se(t)}function se(t,s){const i=new ue({id:t,element:ve(t),stopEvent:!1,positioning:"center-center",position:s,className:"overlay-dot-container"});v.addOverlay(i),x.push(i)}te(),ae(()=>{v.on("moveend",S),b.on("removeDotByIdx",t=>{j(z,d=(d==null?void 0:d.filter(s=>s.idx!==t))??null,d),x.forEach(s=>{s.get("idx")===t&&(s.set("idx",void 0),s.setPosition(void 0))})})});function S(){const t=v.getView().getZoom();if(!t)return;const s=v.getView().calculateExtent(v.getSize()),i=[];x.forEach(e=>{e.set("uncheck",!0);const f=e.getPosition();(!f||!E(s,f))&&i.push(e)});const a=[],u=Math.ceil(t),h=(d==null?void 0:d.filter(e=>E(s,[e.x,e.y])))??[];I.forEachTileCoord(s,u,e=>{let f=!0;const n=I.getTileCoordExtent(e),o=h.find(l=>E(n,[l.x,l.y])),c=[];if(o){const l=x.find(r=>r.get("idx")===o.idx);if(l)l.set("uncheck",!1),c.push(l),f=!1;else{const r=i.pop();r&&(c.push(r),r.setPosition([o.x,o.y]),r.set("idx",o.idx),r.set("ownerIdx",o.ownerIdx),r.set("uncheck",!1),r.set("reverse-z",1),U(r,o,JSON.stringify(e)),f=!1)}}x.filter(l=>{if(c.some(m=>m.get("idx")===l.get("idx")))return!1;const r=l.getPosition();return r?E(n,r):!1}).sort((l,r)=>(r.get("reverse-z")??0)-(l.get("reverse-z")??1)).forEach((l,r)=>{const m=l.getPosition();A!=="moon"&&r===0&&!F(m,c)?(l.set("uncheck",!1),f=!1):(l.set("idx",void 0),l.setPosition(void 0))}),f&&a.push(e)}),A!=="moon"&&a.forEach(e=>{const f=I.getTileCoordExtent(e),[n,o,c]=e;let l=!1;if(g[n]?g[n][o]?g[n][o][c]?l=!0:g[n][o][c]=[]:g[n][o]={[c]:[]}:g[n]={[o]:{[c]:[]}},l){if(g[n][o][c].length===0)return;const r=[];for(const m of g[n][o][c]){const M=x.find(w=>w.get("idx")===m.idx);if(M){M.set("uncheck",!1);return}r.push(m);break}if(r.length===0)return;q(r,f,e);return}fetch(`${P}/posts/dots/${n}/${o}/${c}`,{headers:{Authorization:`Bearer ${k}`,"x-api-version":N.DOTS}}).then(r=>r.json()).then(r=>{const m=g[n][o][c];r.data.forEach(w=>{if(m.some(re=>re.idx===w.idx))return;const ne=Y(w.score),oe={...w,ownerIdx:w.owner_idx,image:G(w.image_url),size:ne};m.push(oe)}),g[n][o][c]=m,m.length!==0&&q([m[0]],f,e)}).catch(r=>console.error(r))})}function q(t,s,i){const[a,u,h]=i,e=x.filter(n=>n.get("uncheck")),f=x.filter(n=>!n.get("uncheck"));t.forEach((n,o)=>{const c=e[o];if(!c)return;const l=[n.x,n.y];F(l,f)||(f.push(c),c.setPosition(l),c.set("idx",n.idx),c.set("ownerIdx",n.ownerIdx),c.set("uncheck",!1),c.set("reverse-z",1/a),U(c,n,JSON.stringify(i)))}),x.forEach(n=>{if(n.get("uncheck")!==!0)return;const o=n.getPosition();o&&E(s,o)&&(n.set("idx",void 0),n.set("uncheck",!1),n.setPosition(void 0))})}function F(t,s,i=226){const a=v.getPixelFromCoordinate(t);return s.some(u=>{const h=u.getPosition();if(!h)return!1;const e=v.getPixelFromCoordinate(h),f=a[0]-e[0],n=a[1]-e[1];return Math.sqrt(f*f+n*n)<i})}function R(t){var u,h;const s=(h=(u=t.currentTarget)==null?void 0:u.dataset)==null?void 0:h.coord;if(!s)return;const i=JSON.parse(s);O(0,y=i);const a=I.getTileCoordExtent(i);d==null||d.forEach((e,f)=>{E(a,[e.x,e.y])&&b.emit("unshiftCard",{idx:e.idx,type:"photo",ownerIdx:e.ownerIdx,image:e.image,emoji:e.emojis,back:e.text,metadata:e.metadata,pushAnimation:"pop"})})}function U(t,s,i){const a=t.getElement();if(!a)return;const u=a.querySelector("img");u&&u.setAttribute("src",s.image);const h=a.querySelector("textPath");h&&(h.innerHTML=s.emojis),a.className=`dot-emoji ${s.size}`,a.removeEventListener("click",R),a.dataset.coord=i,a.addEventListener("click",R)}return ce(()=>{v.un("moveend",S),W(),Q(),ee()}),p.$$.update=()=>{p.$$.dirty&1&&(y?L(y):(_=0,B.set(!0),H.set(!0),$.set(!0),Z.set(!1)))},[y]}class De extends le{constructor(C){super(),de(this,C,we,null,ie,{})}}export{De as D};
