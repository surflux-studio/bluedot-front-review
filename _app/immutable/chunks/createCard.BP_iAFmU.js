import{g,a as w}from"./sign.Cl6bdCIL.js";import{e as n}from"./emitter.E5P-NQ8u.js";import{i as y,A as b,e as x,c as p,j as D,a as I,s as P}from"./store.C3f-MM0q.js";import{C as d,a as v,b as C,t as c,F as k,h as A}from"./full.esm.EEA9OnAZ.js";import{f as E}from"./map.C7MrUMM9.js";import{O as T,E as S}from"./scheduler.BIy9gGKi.js";import{s as j}from"./Map.-MQNuWc5.js";import{g as u}from"./uuid.BbJUX8XE.js";import{g as F}from"./overlay.D2uvO7-w.js";async function B(s){return new Promise((i,t)=>{const e=new Image;e.onload=()=>{const a=document.createElement("canvas");let o=e.width,r=e.height;o>r?o>1280&&(r=Math.round(r*1280/o),o=1280):r>720&&(o=Math.round(o*720/r),r=720),a.width=o,a.height=r;const m=a.getContext("2d");if(!m){t(new Error("Canvas context not available"));return}m.drawImage(e,0,0,o,r),i(a.toDataURL("image/jpeg",.9))},e.onerror=()=>t(new Error("Failed to load image")),e.src=s})}async function f(s){const i=await fetch(s).then(e=>e.blob()),t=await A({blob:i,toType:"image/jpeg",quality:.9});return new Promise(e=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.readAsDataURL(t)})}async function L(){let s,i={};if(y){const t=await d.requestPermissions({permissions:["camera","photos"]});if(t.camera!=="granted"||t.photos!=="granted"&&t.photos!=="limited")throw n.emit("pushSnackbar",{message:"사진 또는 카메라 권한이 필요합니다. 설정에서 허용해주세요."}),new Error("권한 거부됨");const e=await d.getPhoto({resultType:v.Base64,source:C.Prompt,saveToGallery:!0,promptLabelHeader:"사진 선택",promptLabelCancel:"취소",promptLabelPhoto:"앨범에서 선택",promptLabelPicture:"카메라로 촬영",quality:90,width:1280,height:1280});if(!e.base64String||!e.format)throw new Error("사진을 가져오지 못했습니다");s=`data:image/${e.format};base64,${e.base64String}`,(e.format==="heic"||e.format==="heif")&&(s=await f(s));const a=atob(e.base64String),o=new Uint8Array(a.length);for(let r=0;r<a.length;r++)o[r]=a.charCodeAt(r);i=await c.parse(o.buffer)}else{const t=(await k.pickImages({readData:!0,limit:1})).files;if(t.length===0)throw new Error("No images selected");const e=t[0];if(!e.data)throw new Error("No image data");s=`data:${e.mimeType};base64,${e.data}`,(e.mimeType==="image/heic"||e.mimeType==="image/heif")&&(s=await f(s)),i=await c.parse(e.data)}if(i.latitude&&i.longitude){const t=E([i.longitude,i.latitude]);n.emit("flyTo",t),i.x=Math.round(t[0]),i.y=Math.round(t[1])}return{base64Url:s,metadata:i}}async function O(s){s=await B(s);const t=await(await fetch(s)).blob();return new File([t],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function U(s,i,t="private",e){const a=new FormData;a.append("image",s),a.append("emojis",i),a.append("visibility",t),e.x&&e.y&&a.append("location",JSON.stringify({x:e.x,y:e.y})),a.append("metadata",JSON.stringify(e));const o=await fetch(`${b}/posts/dots`,{method:"POST",headers:{"x-api-version":x.DOTS,Authorization:`Bearer ${g()}`},body:a}),r=await o.json();if(!o.ok)throw new Error(r.message||"Failed to create dot");return r.data}async function G(){if(!g()){n.emit("pushCard",{idx:u(),type:"signIn",pushAnimation:"pop",unflippable:!0});return}let i=u(),t="",e={},a=null,o=null;try{const{base64Url:r,metadata:m}=await L();if(p.set(!1),n.emit("loading",!0),t=r,e=m,t.length===0)throw new Error("No images selected")}catch{n.emit("removeCardByIdx",{idx:i}),p.set(!0);return}finally{n.emit("loading",!1)}n.emit("pushCard",{idx:i,type:"photo",unflippable:!0,ownerIdx:String(w()),image:t,emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",right:"모두가 볼 수 있게 남겨요",rightColor:"positive",unDroppable:!0,pushAnimation:"pop",onPreDropLeft:async()=>{n.emit("blockWindowEvents",!0),await h(i,a,o,"private",e)},onPreDropRight:async()=>{n.emit("blockWindowEvents",!0),await h(i,a,o,"public",e)},onPostDrop:()=>{p.set(!0)}}),D.set({isOpen:!0,type:"emoji"}),a=await O(t),o=T(I).find(r=>r.idx===i)}async function h(s,i,t,e,a){n.emit("animateCardByIdx",{idx:s,card:{pushAnimation:"shake"}});const o=await U(i,(t==null?void 0:t.type)==="photo"?t.emoji:"",e,a),r=j(o.image_url);P.update(m=>{const l={...o,ownerIdx:o.owner_idx,image:r,size:F(o.score)};return m?m.push(l):m=[l],m}),n.emit("animateCardByIdx",{idx:s,card:{pushAnimation:"none"}}),n.emit("setCardByIdx",{idx:s,card:{image:r,back:o.text,unflippable:!1,onPreDropLeft:()=>{},onPreDropRight:()=>{},unDroppable:!1,left:"",right:""}}),await S(),n.emit("animateCardByIdx",{idx:s,card:{pushAnimation:"create",pushDuration:4e3,isFlipped:!0}}),n.emit("showFirework"),setTimeout(()=>{n.emit("blockWindowEvents",!1)},4e3)}export{G as c};
