import{W as g}from"./device.D8yUi0Ns.js";class f extends g{constructor(){super(...arguments),this.googleClientId=null,this.appleClientId=null,this.googleScriptLoaded=!1,this.appleScriptLoaded=!1,this.appleScriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js",this.facebookAppId=null,this.facebookScriptLoaded=!1}async initialize(e){var l,o,a;!((l=e.google)===null||l===void 0)&&l.webClientId&&(this.googleClientId=e.google.webClientId,await this.loadGoogleScript()),!((o=e.apple)===null||o===void 0)&&o.clientId&&(this.appleClientId=e.apple.clientId,await this.loadAppleScript()),!((a=e.facebook)===null||a===void 0)&&a.appId&&(this.facebookAppId=e.facebook.appId,await this.loadFacebookScript(),FB.init({appId:this.facebookAppId,version:"v17.0",xfbml:!0,cookie:!0}))}async login(e){if(e.provider==="google")return this.loginWithGoogle(e.options);if(e.provider==="apple")return this.loginWithApple(e.options);if(e.provider==="facebook")return this.loginWithFacebook(e.options);throw new Error(`Login for ${e.provider} is not implemented on web`)}async logout(e){switch(e.provider){case"google":console.log("Google logout: Token should be revoked on the client side if stored");break;case"apple":console.log("Apple logout: Session should be managed on the client side");break;case"facebook":return new Promise(l=>{FB.logout(()=>l())});default:throw new Error(`Logout for ${e.provider} is not implemented`)}}async isLoggedIn(e){switch(e.provider){case"google":return{isLoggedIn:!!await this.getGoogleUser()};case"apple":return console.log("Apple login status should be managed on the client side"),{isLoggedIn:!1};case"facebook":return new Promise(o=>{FB.getLoginStatus(a=>{o({isLoggedIn:a.status==="connected"})})});default:throw new Error(`isLoggedIn for ${e.provider} is not implemented`)}}async getAuthorizationCode(e){switch(e.provider){case"google":const l=await this.getGoogleUser();if(l&&l.credential)return{jwt:l.credential};throw new Error("No Google authorization code available");case"apple":throw console.log("Apple authorization code should be stored during login"),new Error("Apple authorization code not available");case"facebook":return new Promise((o,a)=>{FB.getLoginStatus(i=>{var t;i.status==="connected"?o({jwt:((t=i.authResponse)===null||t===void 0?void 0:t.accessToken)||""}):a(new Error("No Facebook authorization code available"))})});default:throw new Error(`getAuthorizationCode for ${e.provider} is not implemented`)}}async refresh(e){switch(e.provider){case"google":await this.loginWithGoogle(e.options);break;case"apple":console.log("Apple refresh not available on web");break;case"facebook":await this.loginWithFacebook(e.options);break;default:throw new Error(`Refresh for ${e.provider} is not implemented`)}}async loginWithGoogle(e){if(!this.googleClientId)throw new Error("Google Client ID not set. Call initialize() first.");const l=e.scopes||["email","profile"];return l.length>0?this.fallbackToTraditionalOAuth(l):new Promise((o,a)=>{google.accounts.id.initialize({client_id:this.googleClientId,callback:i=>{if(console.log("google.accounts.id.initialize callback",i),i.error)a(i.error);else{const t=this.parseJwt(i.credential),n={accessToken:null,idToken:i.credential,profile:{email:t.email||null,familyName:t.family_name||null,givenName:t.given_name||null,id:t.sub||null,name:t.name||null,imageUrl:t.picture||null}};o({provider:"google",result:n})}},auto_select:!0}),google.accounts.id.prompt(i=>{i.isNotDisplayed()||i.isSkippedMoment()?(console.log("OneTap is not displayed or skipped"),this.fallbackToTraditionalOAuth(l).then(o).catch(a)):console.log("OneTap is displayed")})})}parseJwt(e){const o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(atob(o).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(a)}async loadGoogleScript(){if(!this.googleScriptLoaded)return new Promise((e,l)=>{const o=document.createElement("script");o.src="https://accounts.google.com/gsi/client",o.async=!0,o.onload=()=>{this.googleScriptLoaded=!0,e()},o.onerror=l,document.body.appendChild(o)})}async loginWithApple(e){if(!this.appleClientId)throw new Error("Apple Client ID not set. Call initialize() first.");if(!this.appleScriptLoaded)throw new Error("Apple Sign-In script not loaded.");return new Promise((l,o)=>{var a;AppleID.auth.init({clientId:this.appleClientId,scope:((a=e.scopes)===null||a===void 0?void 0:a.join(" "))||"name email",redirectURI:e.redirectUrl||window.location.href,state:e.state,nonce:e.nonce,usePopup:!0}),AppleID.auth.signIn().then(i=>{var t,n,r,s,c,d,p;const u={profile:{user:!((n=(t=i.user)===null||t===void 0?void 0:t.name)===null||n===void 0)&&n.firstName?`${i.user.name.firstName} ${i.user.name.lastName}`:"",email:((r=i.user)===null||r===void 0?void 0:r.email)||null,givenName:((c=(s=i.user)===null||s===void 0?void 0:s.name)===null||c===void 0?void 0:c.firstName)||null,familyName:((p=(d=i.user)===null||d===void 0?void 0:d.name)===null||p===void 0?void 0:p.lastName)||null},accessToken:{token:i.authorization.code},idToken:i.authorization.id_token||null};l({provider:"apple",result:u})}).catch(i=>{o(i)})})}async loadAppleScript(){if(!this.appleScriptLoaded)return new Promise((e,l)=>{const o=document.createElement("script");o.src=this.appleScriptUrl,o.async=!0,o.onload=()=>{this.appleScriptLoaded=!0,e()},o.onerror=l,document.body.appendChild(o)})}async getGoogleUser(){return new Promise(e=>{google.accounts.id.initialize({client_id:this.googleClientId,callback:l=>{e(l)}}),google.accounts.id.prompt(l=>{(l.isNotDisplayed()||l.isSkippedMoment())&&e(null)})})}async loadFacebookScript(){if(!this.facebookScriptLoaded)return new Promise((e,l)=>{const o=document.createElement("script");o.src="https://connect.facebook.net/en_US/sdk.js",o.async=!0,o.defer=!0,o.onload=()=>{this.facebookScriptLoaded=!0,e()},o.onerror=l,document.body.appendChild(o)})}async loginWithFacebook(e){if(!this.facebookAppId)throw new Error("Facebook App ID not set. Call initialize() first.");return new Promise((l,o)=>{FB.login(a=>{a.status==="connected"?FB.api("/me",{fields:"id,name,email,picture"},i=>{var t,n;const r={accessToken:{token:a.authResponse.accessToken,userId:a.authResponse.userID},profile:{userID:i.id,name:i.name,email:i.email||null,imageURL:((n=(t=i.picture)===null||t===void 0?void 0:t.data)===null||n===void 0?void 0:n.url)||null,friendIDs:[],birthday:null,ageRange:null,gender:null,location:null,hometown:null,profileURL:null},idToken:null};l({provider:"facebook",result:r})}):o(new Error("Facebook login failed"))},{scope:e.permissions.join(",")})})}async fallbackToTraditionalOAuth(e){return new Promise((l,o)=>{google.accounts.oauth2.initTokenClient({client_id:this.googleClientId,scope:e.join(" "),callback:i=>{if(i.error)o(i.error);else{const t=this.parseJwt(i.access_token),n={accessToken:{token:i.access_token},idToken:null,profile:{email:t.email||null,familyName:t.family_name||null,givenName:t.given_name||null,id:t.sub||null,name:t.name||null,imageUrl:t.picture||null}};l({provider:"google",result:n})}}}).requestAccessToken()})}}export{f as SocialLoginWeb};
