import{g as l,a as u}from"./sign.D86YKlRA.js";import{e as s}from"./emitter.E5P-NQ8u.js";import{i as g,A as f,e as x,k as h,a as w,s as y}from"./store.DC0yGTSS.js";import{C as b,F as I,t as D,h as v}from"./full.esm.DllmHrzh.js";import{f as k}from"./map.mLarmJ8y.js";import{R as P,E as C}from"./scheduler.CGPrvQej.js";import{s as U}from"./s32cloudfront.BG9AkwYI.js";import{g as E}from"./overlay.D2uvO7-w.js";async function A(n){return new Promise((r,i)=>{const a=new Image;a.onload=()=>{const o=document.createElement("canvas");let e=a.width,t=a.height;e>t?e>1280&&(t=Math.round(t*1280/e),e=1280):t>720&&(e=Math.round(e*720/t),t=720),o.width=e,o.height=t;const d=o.getContext("2d");if(!d){i(new Error("Canvas context not available"));return}d.drawImage(a,0,0,e,t),r(o.toDataURL("image/jpeg",.9))},a.onerror=()=>i(new Error("Failed to load image")),a.src=n})}async function F(n){const r=await fetch(n).then(a=>a.blob()),i=await v({blob:r,toType:"image/jpeg",quality:.9});return new Promise(a=>{const o=new FileReader;o.onloadend=()=>a(o.result),o.readAsDataURL(i)})}async function T(){if(g){const t=await b.requestPermissions({permissions:["photos"]});if(t.photos!=="granted"&&t.photos!=="limited")throw s.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const n=(await I.pickImages({readData:!0,limit:1})).files;if(n.length===0)throw new Error("No images selected");const r=n[0];if(!r.data)throw new Error("No image data");const i=await D.parse(r.data),a=i.latitude,o=i.longitude;if(a&&o){const t=k([o,a]);s.emit("flyTo",t),i.x=Math.round(t[0]),i.y=Math.round(t[1])}let e=`data:${r.mimeType};base64,${r.data}`;return(r.mimeType==="image/heic"||r.mimeType==="image/heif")&&(e=await F(e)),{base64Url:e,metadata:i}}async function B(n){n=await A(n);const i=await(await fetch(n)).blob();return new File([i],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function j(n,r,i="private",a){const o=new FormData;o.append("image",n),o.append("emojis",r),o.append("visibility",i),a.x&&a.y&&o.append("location",JSON.stringify({x:a.x,y:a.y})),o.append("metadata",JSON.stringify(a));const e=await fetch(`${f}/posts/dots`,{method:"POST",headers:{"x-api-version":x.DOTS,Authorization:`Bearer ${l()}`},body:o}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to create dot");return t.data}function p(){return typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;return(n==="x"?r:r&3|8).toString(16)})}async function J(){const n=l();let r="",i={},a=null,o=null;if(!n){s.emit("pushCard",{idx:p(),type:"signIn",unflippable:!0});return}let e=p();s.emit("pushCard",{idx:e,type:"photo",unflippable:!0,ownerIdx:String(u()),image:"/graydot.png",emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",right:"모두가 볼 수 있게 남겨요",rightColor:"positive",unDroppable:!0,onPreDropLeft:async()=>{s.emit("blockWindowEvents",!0),await c(e,a,o,"private",i)},onPreDropRight:async()=>{s.emit("blockWindowEvents",!0),await c(e,a,o,"public",i)},onLoad:async()=>{try{const{base64Url:t,metadata:d}=await T();if(r=t,i=d,r.length===0)throw new Error("No images selected")}catch{s.emit("removeCardByIdx",{idx:e}),s.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}s.emit("setCardByIdx",{idx:e,card:{image:r}}),h.set({isOpen:!0,type:"emoji"}),a=await B(r),o=P(w).find(t=>t.idx===e)}})}async function c(n,r,i,a,o){s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"shake"}});const e=await j(r,(i==null?void 0:i.type)==="photo"?i.emoji:"",a,o),t=U(e.image_url);y.update(d=>{const m={...e,ownerIdx:e.owner_idx,image:t,size:E(e.score)};return d?d.push(m):d=[m],d}),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"none"}}),s.emit("setCardByIdx",{idx:n,card:{image:t,back:e.text,unflippable:!1,onPreDropLeft:()=>{},onPreDropRight:()=>{},unDroppable:!1,left:"",right:""}}),await C(),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"create",pushDuration:4e3,isFlipped:!0}}),s.emit("showFirework"),setTimeout(()=>{s.emit("blockWindowEvents",!1)},4e3)}export{J as c};
