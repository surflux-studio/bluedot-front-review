import{g as u,a as f}from"./sign.WJSey9PU.js";import{e as s}from"./emitter.E5P-NQ8u.js";import{i as g,A as h,e as w,c as p,j as y,a as b,s as x}from"./store.DvibATJI.js";import{C as D,F as I,t as v,h as P}from"./full.esm.CRxm2yTd.js";import{f as k}from"./map.DWtPTH7u.js";import{O as E,E as A}from"./scheduler.BIy9gGKi.js";import{s as C}from"./Map.CHZy6Pk2.js";import{g as l}from"./uuid.BbJUX8XE.js";import{g as j}from"./overlay.D2uvO7-w.js";async function F(n){return new Promise((r,i)=>{const t=new Image;t.onload=()=>{const o=document.createElement("canvas");let a=t.width,e=t.height;a>e?a>1280&&(e=Math.round(e*1280/a),a=1280):e>720&&(a=Math.round(a*720/e),e=720),o.width=a,o.height=e;const m=o.getContext("2d");if(!m){i(new Error("Canvas context not available"));return}m.drawImage(t,0,0,a,e),r(o.toDataURL("image/jpeg",.9))},t.onerror=()=>i(new Error("Failed to load image")),t.src=n})}async function T(n){const r=await fetch(n).then(t=>t.blob()),i=await P({blob:r,toType:"image/jpeg",quality:.9});return new Promise(t=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.readAsDataURL(i)})}async function O(){if(g){const e=await D.requestPermissions({permissions:["photos"]});if(e.photos!=="granted"&&e.photos!=="limited")throw s.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const n=(await I.pickImages({readData:!0,limit:1})).files;if(n.length===0)throw new Error("No images selected");const r=n[0];if(!r.data)throw new Error("No image data");const i=await v.parse(r.data),t=i.latitude,o=i.longitude;if(t&&o){const e=k([o,t]);s.emit("flyTo",e),i.x=Math.round(e[0]),i.y=Math.round(e[1])}let a=`data:${r.mimeType};base64,${r.data}`;return(r.mimeType==="image/heic"||r.mimeType==="image/heif")&&(a=await T(a)),{base64Url:a,metadata:i}}async function _(n){n=await F(n);const i=await(await fetch(n)).blob();return new File([i],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function B(n,r,i="private",t){const o=new FormData;o.append("image",n),o.append("emojis",r),o.append("visibility",i),t.x&&t.y&&o.append("location",JSON.stringify({x:t.x,y:t.y})),o.append("metadata",JSON.stringify(t));const a=await fetch(`${h}/posts/dots`,{method:"POST",headers:{"x-api-version":w.DOTS,Authorization:`Bearer ${u()}`},body:o}),e=await a.json();if(!a.ok)throw new Error(e.message||"Failed to create dot");return e.data}async function W(){if(!u()){s.emit("pushCard",{idx:l(),type:"signIn",pushAnimation:"pop",unflippable:!0});return}let r=l(),i="",t={},o=null,a=null;try{const{base64Url:e,metadata:m}=await O();if(p.set(!1),s.emit("loading",!0),i=e,t=m,i.length===0)throw new Error("No images selected")}catch{s.emit("removeCardByIdx",{idx:r}),p.set(!0);return}finally{s.emit("loading",!1)}s.emit("pushCard",{idx:r,type:"photo",unflippable:!0,ownerIdx:String(f()),image:i,emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",right:"모두가 볼 수 있게 남겨요",rightColor:"positive",unDroppable:!0,pushAnimation:"pop",onPreDropLeft:async()=>{s.emit("blockWindowEvents",!0),await c(r,o,a,"private",t)},onPreDropRight:async()=>{s.emit("blockWindowEvents",!0),await c(r,o,a,"public",t)},onPostDrop:()=>{p.set(!0)}}),y.set({isOpen:!0,type:"emoji"}),o=await _(i),a=E(b).find(e=>e.idx===r)}async function c(n,r,i,t,o){s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"shake"}});const a=await B(r,(i==null?void 0:i.type)==="photo"?i.emoji:"",t,o),e=C(a.image_url);x.update(m=>{const d={...a,ownerIdx:a.owner_idx,image:e,size:j(a.score)};return m?m.push(d):m=[d],m}),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"none"}}),s.emit("setCardByIdx",{idx:n,card:{image:e,back:a.text,unflippable:!1,onPreDropLeft:()=>{},onPreDropRight:()=>{},unDroppable:!1,left:"",right:""}}),await A(),s.emit("animateCardByIdx",{idx:n,card:{pushAnimation:"create",pushDuration:4e3,isFlipped:!0}}),s.emit("showFirework"),setTimeout(()=>{s.emit("blockWindowEvents",!1)},4e3)}export{W as c};
