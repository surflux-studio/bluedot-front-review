import{R as X,s as Y,A as Z,e as f,a as b,c as A,b as U,f as E,g as y,m as _,o as x,i as v,h,p as k,B as F,C as tt,v as et}from"../chunks/scheduler.I7jjIWdo.js";import{S as ut,i as at,e as it,c as L,b as V,m as J,t as q,a as z,d as G}from"../chunks/index.DN2oNe6D.js";import{C as ot}from"../chunks/CardDeck.DUUFIEtr.js";import{f as st,s as H,M as nt}from"../chunks/Map.DlFsBmOO.js";import{e as r}from"../chunks/emitter.E5P-NQ8u.js";import{i as rt,A as Ct,b as lt,c as Bt}from"../chunks/store.DqdLFdOX.js";import"../chunks/CardOption.CqBQjCK7.js";import"../chunks/keyboard.xYhDQsCz.js";import"../chunks/InputDim.DuTEwCbb.js";import{g as Q,a as dt,s as ct}from"../chunks/sign.CuZeacrB.js";import"../chunks/entry.DM8ixu-w.js";import{C as pt,F as mt,t as gt,h as ht}from"../chunks/heic2any.BRh7kPbh.js";async function ft(s){return new Promise((u,a)=>{const o=new Image;o.onload=()=>{const t=document.createElement("canvas");let i=o.width,e=o.height;i>e?i>1280&&(e=Math.round(e*1280/i),i=1280):e>720&&(i=Math.round(i*720/e),e=720),t.width=i,t.height=e;const C=t.getContext("2d");if(!C){a(new Error("Canvas context not available"));return}C.drawImage(o,0,0,i,e),u(t.toDataURL("image/jpeg",.9))},o.onerror=()=>a(new Error("Failed to load image")),o.src=s})}async function At(s){const u=await fetch(s).then(o=>o.blob()),a=await ht({blob:u,toType:"image/jpeg",quality:.9});return new Promise(o=>{const t=new FileReader;t.onloadend=()=>o(t.result),t.readAsDataURL(a)})}async function Et(){if(rt){const e=await pt.requestPermissions({permissions:["photos"]});if(e.photos!=="granted"&&e.photos!=="limited")throw r.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const s=(await mt.pickImages({readData:!0,limit:1})).files;if(s.length===0)throw new Error("No images selected");const u=s[0];if(!u.data)throw new Error("No image data");const a=await gt.parse(u.data),o=a.latitude,t=a.longitude;o&&t&&r.emit("flyTo",st([t,o]));let i=`data:${u.mimeType};base64,${u.data}`;return(u.mimeType==="image/heic"||u.mimeType==="image/heif")&&(i=await At(i)),{base64Url:i,metadata:a}}async function xt(s){s=await ft(s);const a=await(await fetch(s)).blob();return new File([a],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function K(s,u,a="private",o,t){const i=new FormData;i.append("image",s),i.append("emojis",u),i.append("visibility",a),i.append("location",JSON.stringify(o)),i.append("metadata",JSON.stringify(t));const e=await fetch(`${Ct}/posts/dots`,{method:"POST",headers:{"x-api-version":lt.DOTS,Authorization:`Bearer ${Q()}`},body:i}),C=await e.json();if(!e.ok)throw new Error(C.message||"Failed to create dot");return C.data}function Dt(){return typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const u=crypto.getRandomValues(new Uint8Array(1))[0]&15;return(s==="x"?u:u&3|8).toString(16)})}async function bt(){const s=Q();let u="",a={},o=null,t=null;if(!s){r.emit("pushCard",{idx:"111",type:"signIn",unflippable:!0});return}let i=Dt();r.emit("pushCard",{idx:i,type:"photo",ownerIdx:String(dt()),image:"/graydot.png",emoji:"",inputDimIsOpen:!1,back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",onDumpLeft:async()=>{r.emit("loading",!0);const e=await K(o,(t==null?void 0:t.type)==="photo"?t.emoji:"","private",{latitude:a.latitude,longitude:a.longitude},a);r.emit("loading",!1),r.emit("pushCard",{...e,type:"photo",image:H(e.image_url),emoji:e.emojis,back:e.text})},right:"모두가 볼 수 있게 남겨요",onDumpRight:async()=>{r.emit("loading",!0);const e=await K(o,(t==null?void 0:t.type)==="photo"?t.emoji:"","public",{latitude:a.latitude,longitude:a.longitude},a);r.emit("loading",!1),r.emit("pushCard",{...e,type:"photo",image:H(e.image_url),emoji:e.emojis,back:e.text})},rightColor:"positive",onLoad:async()=>{try{const{base64Url:e,metadata:C}=await Et();if(u=e,a=C,u.length===0)throw new Error("No images selected")}catch{r.emit("removeCardByIdx",{idx:i}),r.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}r.emit("setCardByIdx",{idx:i,card:{image:u,inputDimIsOpen:!0}}),o=await xt(u),t=X(Bt).find(e=>e.idx===i)}})}function yt(s){let u,a,o,t,i,e,C,l,B,O="카드 덱 불러오기",$,c,R="카드 하나 추가하기",I,p,N="로그아웃",j,m,P="카드 신규 등록하기",w,T,S;a=new nt({});function W(n){s[2](n)}let M={};return s[0]!==void 0&&(M.cards=s[0]),t=new ot({props:M}),Z.push(()=>it(t,"cards",W)),{c(){u=f("div"),L(a.$$.fragment),o=b(),L(t.$$.fragment),e=b(),C=f("div"),l=f("div"),B=f("button"),B.textContent=O,$=b(),c=f("button"),c.textContent=R,I=b(),p=f("button"),p.textContent=N,j=b(),m=f("button"),m.textContent=P,this.h()},l(n){u=A(n,"DIV",{class:!0});var d=U(u);V(a.$$.fragment,d),d.forEach(E),o=y(n),V(t.$$.fragment,n),e=y(n),C=A(n,"DIV",{class:!0});var D=U(C);l=A(D,"DIV",{class:!0});var g=U(l);B=A(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(B)!=="svelte-1ypo7e6"&&(B.textContent=O),$=y(g),c=A(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(c)!=="svelte-34rce8"&&(c.textContent=R),I=y(g),p=A(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(p)!=="svelte-697xgu"&&(p.textContent=N),j=y(g),m=A(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(m)!=="svelte-108817t"&&(m.textContent=P),g.forEach(E),D.forEach(E),this.h()},h(){x(u,"class","fixed inset-0"),x(B,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),x(c,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),x(p,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),x(m,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),x(l,"class","flex gap-4"),x(C,"class","fixed w-full bottom-0 p-6 z-[100]")},m(n,d){v(n,u,d),J(a,u,null),v(n,o,d),J(t,n,d),v(n,e,d),v(n,C,d),h(C,l),h(l,B),h(l,$),h(l,c),h(l,I),h(l,p),h(l,j),h(l,m),w=!0,T||(S=[k(B,"click",F(s[3])),k(c,"click",F(s[4])),k(p,"click",F(s[5])),k(m,"click",F(bt))],T=!0)},p(n,[d]){const D={};!i&&d&1&&(i=!0,D.cards=n[0],tt(()=>i=!1)),t.$set(D)},i(n){w||(q(a.$$.fragment,n),q(t.$$.fragment,n),w=!0)},o(n){z(a.$$.fragment,n),z(t.$$.fragment,n),w=!1},d(n){n&&(E(u),E(o),E(e),E(C)),G(a),G(t,n),T=!1,et(S)}}}function wt(s,u,a){let o=[{idx:"1",type:"photo",image:"/h1.jpeg",emoji:"🧸🎀✨💎✨🎀",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 위에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"10",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"top",pushOffset:300})}},{idx:"2",type:"photo",image:"/h2.png",emoji:"🔥🌴😆🚂",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 오른쪽에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"9",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"right",pushOffset:300})}},{idx:"3",type:"photo",image:"/h1.jpeg",emoji:"🧸🎀✨💎✨🎀",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 아래에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"8",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"bottom",pushOffset:300})}},{idx:"4",type:"photo",image:"/h2.png",emoji:"🔥🌴😆🚂",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 왼쪽에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"7",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"left",pushOffset:300})}},{idx:"5",type:"photo",image:"/h1.jpeg",emoji:"👀👀👀👀👀",back:"첫눈 오는 날, 눈 코에 묻히고 공 물고 웃던 너. 그 순간이 겨울의 선물 같았어.",left:"넘어갈게",right:"카드 한장 뿅하고 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"6",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기"})}},{idx:"7",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"넘어갈게",right:"넘어갈게"},{idx:"8",type:"signIn",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",unflippable:!0}];const t=o;function i(B){o=B,a(0,o)}return[o,t,i,()=>{r.emit("setCards",t)},()=>{r.emit("pushCard",{idx:"10",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"넘어갈게",right:"넘어갈게"})},()=>{ct()}]}class Pt extends ut{constructor(u){super(),at(this,u,wt,yt,Y,{})}}export{Pt as component};
