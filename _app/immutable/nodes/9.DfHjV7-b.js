import{R as Y,s as Z,A as tt,e as f,a as b,c as x,b as U,f as A,g as w,m as _,o as E,i as v,h,p as k,B as F,C as et,v as ut}from"../chunks/scheduler.BRSuf-vg.js";import{S as at,i as it,e as ot,c as V,b as J,m as q,t as z,a as G,d as H}from"../chunks/index.C48quBYD.js";import{C as st}from"../chunks/CardDeck.CLqE0YOG.js";import{f as nt,s as K,M as rt}from"../chunks/Map.B3z2y8KZ.js";import{e as r}from"../chunks/emitter.E5P-NQ8u.js";import{i as Ct,A as lt,a as dt,s as ct,b as pt}from"../chunks/store.BuEJqzLV.js";import"../chunks/CardOption.D8sQ6nv-.js";import{g as W,a as O,s as mt}from"../chunks/index.eXkzb036.js";import"../chunks/entry.DSlDJSgx.js";import{C as Bt,F as gt,t as ht,h as ft}from"../chunks/heic2any.DzklR3MQ.js";async function xt(s){return new Promise((u,a)=>{const o=new Image;o.onload=()=>{const t=document.createElement("canvas");let i=o.width,e=o.height;i>e?i>1280&&(e=Math.round(e*1280/i),i=1280):e>720&&(i=Math.round(i*720/e),e=720),t.width=i,t.height=e;const C=t.getContext("2d");if(!C){a(new Error("Canvas context not available"));return}C.drawImage(o,0,0,i,e),u(t.toDataURL("image/jpeg",.9))},o.onerror=()=>a(new Error("Failed to load image")),o.src=s})}async function At(s){const u=await fetch(s).then(o=>o.blob()),a=await ft({blob:u,toType:"image/jpeg",quality:.9});return new Promise(o=>{const t=new FileReader;t.onloadend=()=>o(t.result),t.readAsDataURL(a)})}async function Et(){if(Ct){const e=await Bt.requestPermissions({permissions:["photos"]});if(e.photos!=="granted"&&e.photos!=="limited")throw r.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const s=(await gt.pickImages({readData:!0,limit:1})).files;if(s.length===0)throw new Error("No images selected");const u=s[0];if(!u.data)throw new Error("No image data");const a=await ht.parse(u.data),o=a.latitude,t=a.longitude;o&&t&&r.emit("flyTo",nt([t,o]));let i=`data:${u.mimeType};base64,${u.data}`;return(u.mimeType==="image/heic"||u.mimeType==="image/heif")&&(i=await At(i)),{base64Url:i,metadata:a}}async function Dt(s){s=await xt(s);const a=await(await fetch(s)).blob();return new File([a],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function Q(s,u,a="private",o,t){const i=new FormData;i.append("image",s),i.append("emojis",u),i.append("visibility",a),i.append("location",JSON.stringify(o)),i.append("metadata",JSON.stringify(t));const e=await fetch(`${lt}/posts/dots`,{method:"POST",headers:{"x-api-version":dt.DOTS,Authorization:`Bearer ${W()}`},body:i}),C=await e.json();if(!e.ok)throw new Error(C.message||"Failed to create dot");return C.data}function bt(){return typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const u=crypto.getRandomValues(new Uint8Array(1))[0]&15;return(s==="x"?u:u&3|8).toString(16)})}async function wt(){const s=W();let u="",a={},o=null,t=null;if(!s){r.emit("pushCard",{idx:"111",type:"signIn",unflippable:!0});return}let i=bt();r.emit("pushCard",{idx:i,type:"photo",unflippable:!0,ownerIdx:String(O()),image:"/graydot.png",emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",onDumpLeft:async()=>{r.emit("loading",!0);const e=await Q(o,(t==null?void 0:t.type)==="photo"?t.emoji:"","private",{latitude:a.latitude,longitude:a.longitude},a);r.emit("loading",!1),r.emit("pushCard",{idx:e.idx,ownerIdx:String(O()),type:"photo",image:K(e.image_url),emoji:e.emojis,back:e.text})},right:"모두가 볼 수 있게 남겨요",onDumpRight:async()=>{r.emit("loading",!0);const e=await Q(o,(t==null?void 0:t.type)==="photo"?t.emoji:"","public",{latitude:a.latitude,longitude:a.longitude},a);r.emit("loading",!1),r.emit("pushCard",{idx:e.idx,ownerIdx:String(O()),type:"photo",image:K(e.image_url),emoji:e.emojis,back:e.text})},rightColor:"positive",onLoad:async()=>{try{const{base64Url:e,metadata:C}=await Et();if(u=e,a=C,u.length===0)throw new Error("No images selected")}catch{r.emit("removeCardByIdx",{idx:i}),r.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}r.emit("setCardByIdx",{idx:i,card:{image:u}}),ct.set({isOpen:!0,type:"emoji"}),o=await Dt(u),t=Y(pt).find(e=>e.idx===i)}})}function yt(s){let u,a,o,t,i,e,C,l,d,R="카드 덱 불러오기",$,p,S="카드 하나 추가하기",I,m,N="로그아웃",j,B,P="카드 신규 등록하기",y,T,M;a=new rt({});function X(n){s[2](n)}let L={};return s[0]!==void 0&&(L.cards=s[0]),t=new st({props:L}),tt.push(()=>ot(t,"cards",X)),{c(){u=f("div"),V(a.$$.fragment),o=b(),V(t.$$.fragment),e=b(),C=f("div"),l=f("div"),d=f("button"),d.textContent=R,$=b(),p=f("button"),p.textContent=S,I=b(),m=f("button"),m.textContent=N,j=b(),B=f("button"),B.textContent=P,this.h()},l(n){u=x(n,"DIV",{class:!0});var c=U(u);J(a.$$.fragment,c),c.forEach(A),o=w(n),J(t.$$.fragment,n),e=w(n),C=x(n,"DIV",{class:!0});var D=U(C);l=x(D,"DIV",{class:!0});var g=U(l);d=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(d)!=="svelte-1ypo7e6"&&(d.textContent=R),$=w(g),p=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(p)!=="svelte-34rce8"&&(p.textContent=S),I=w(g),m=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(m)!=="svelte-697xgu"&&(m.textContent=N),j=w(g),B=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(B)!=="svelte-108817t"&&(B.textContent=P),g.forEach(A),D.forEach(A),this.h()},h(){E(u,"class","fixed inset-0"),E(d,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(p,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(m,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(B,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(l,"class","flex gap-4"),E(C,"class","fixed w-full bottom-0 p-6 z-[100]")},m(n,c){v(n,u,c),q(a,u,null),v(n,o,c),q(t,n,c),v(n,e,c),v(n,C,c),h(C,l),h(l,d),h(l,$),h(l,p),h(l,I),h(l,m),h(l,j),h(l,B),y=!0,T||(M=[k(d,"click",F(s[3])),k(p,"click",F(s[4])),k(m,"click",F(s[5])),k(B,"click",F(wt))],T=!0)},p(n,[c]){const D={};!i&&c&1&&(i=!0,D.cards=n[0],et(()=>i=!1)),t.$set(D)},i(n){y||(z(a.$$.fragment,n),z(t.$$.fragment,n),y=!0)},o(n){G(a.$$.fragment,n),G(t.$$.fragment,n),y=!1},d(n){n&&(A(u),A(o),A(e),A(C)),H(a),H(t,n),T=!1,ut(M)}}}function _t(s,u,a){let o=[{idx:"1",type:"photo",image:"/h1.jpeg",emoji:"🧸🎀✨💎✨🎀",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 위에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"10",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"top",pushOffset:300})}},{idx:"2",type:"photo",image:"/h2.png",emoji:"🔥🌴😆🚂",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 오른쪽에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"9",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"right",pushOffset:300})}},{idx:"3",type:"photo",image:"/h1.jpeg",emoji:"🧸🎀✨💎✨🎀",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 아래에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"8",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"bottom",pushOffset:300})}},{idx:"4",type:"photo",image:"/h2.png",emoji:"🔥🌴😆🚂",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 왼쪽에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"7",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"left",pushOffset:300})}},{idx:"5",ownerIdx:"5",type:"photo",image:"/h1.jpeg",emoji:"👀👀👀👀👀",back:"첫눈 오는 날, 눈 코에 묻히고 공 물고 웃던 너. 그 순간이 겨울의 선물 같았어.",left:"넘어갈게",right:"카드 한장 뿅하고 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"6",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기"})}}];const t=o;function i(d){o=d,a(0,o)}return[o,t,i,()=>{r.emit("setCards",t)},()=>{r.emit("pushCard",{idx:"10",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"넘어갈게",right:"넘어갈게"})},()=>{mt()}]}class St extends at{constructor(u){super(),it(this,u,_t,yt,Z,{})}}export{St as component};
