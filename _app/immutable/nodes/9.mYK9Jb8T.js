import{R as Y,s as Z,A as tt,e as f,a as b,c as x,b as U,f as A,g as w,m as _,o as E,i as v,h,p as k,B as F,C as et,v as ut}from"../chunks/scheduler.BRSuf-vg.js";import{S as at,i as it,e as ot,c as V,b as J,m as q,t as z,a as G,d as H}from"../chunks/index.C48quBYD.js";import{C as st}from"../chunks/CardDeck.Bg53okA2.js";import{f as nt,s as K,M as rt}from"../chunks/Map.EifOprsS.js";import{e as r}from"../chunks/emitter.E5P-NQ8u.js";import{i as Ct,A as lt,a as dt,s as ct,b as pt}from"../chunks/store.CDalJydL.js";import"../chunks/CardOption.CspikdPk.js";import{g as W,a as O,s as Bt}from"../chunks/index.Do7nUb9h.js";import"../chunks/entry.D4uLwyBi.js";import{C as mt,F as gt,t as ht,h as ft}from"../chunks/heic2any.DNwmm2Sv.js";async function xt(s){return new Promise((a,i)=>{const u=new Image;u.onload=()=>{const t=document.createElement("canvas");let o=u.width,e=u.height;o>e?o>1280&&(e=Math.round(e*1280/o),o=1280):e>720&&(o=Math.round(o*720/e),e=720),t.width=o,t.height=e;const C=t.getContext("2d");if(!C){i(new Error("Canvas context not available"));return}C.drawImage(u,0,0,o,e),a(t.toDataURL("image/jpeg",.9))},u.onerror=()=>i(new Error("Failed to load image")),u.src=s})}async function At(s){const a=await fetch(s).then(u=>u.blob()),i=await ft({blob:a,toType:"image/jpeg",quality:.9});return new Promise(u=>{const t=new FileReader;t.onloadend=()=>u(t.result),t.readAsDataURL(i)})}async function Et(){if(Ct){const e=await mt.requestPermissions({permissions:["photos"]});if(e.photos!=="granted"&&e.photos!=="limited")throw r.emit("pushSnackbar",{message:"사진에 접근할 수 없습니다. 권한을 허용해주세요."}),new Error("Photos permission not granted")}const s=(await gt.pickImages({readData:!0,limit:1})).files;if(s.length===0)throw new Error("No images selected");const a=s[0];if(!a.data)throw new Error("No image data");const i=await ht.parse(a.data),u=i.latitude,t=i.longitude;u&&t&&r.emit("flyTo",nt([t,u]));let o=`data:${a.mimeType};base64,${a.data}`;return(a.mimeType==="image/heic"||a.mimeType==="image/heif")&&(o=await At(o)),{base64Url:o,metadata:i}}async function Dt(s){s=await xt(s);const i=await(await fetch(s)).blob();return new File([i],"image.jpg",{type:"image/jpeg",lastModified:Date.now()})}async function Q(s,a,i="private",u){const t=new FormData;t.append("image",s),t.append("emojis",a),t.append("visibility",i),u.longitude&&u.latitude&&t.append("location",JSON.stringify({longitude:u.longitude,latitude:u.latitude})),t.append("metadata",JSON.stringify(u));const o=await fetch(`${lt}/posts/dots`,{method:"POST",headers:{"x-api-version":dt.DOTS,Authorization:`Bearer ${W()}`},body:t}),e=await o.json();if(!o.ok)throw new Error(e.message||"Failed to create dot");return e.data}function bt(){return typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const a=crypto.getRandomValues(new Uint8Array(1))[0]&15;return(s==="x"?a:a&3|8).toString(16)})}async function wt(){const s=W();let a="",i={},u=null,t=null;if(!s){r.emit("pushCard",{idx:"111",type:"signIn",unflippable:!0});return}let o=bt();r.emit("pushCard",{idx:o,type:"photo",unflippable:!0,ownerIdx:String(O()),image:"/graydot.png",emoji:"",back:"카드 뒷면입니다",left:"나만 볼 수 있게 담아둘게요",onDumpLeft:async()=>{r.emit("loading",!0);const e=await Q(u,(t==null?void 0:t.type)==="photo"?t.emoji:"","private",i);r.emit("loading",!1),r.emit("pushCard",{idx:e.idx,ownerIdx:String(O()),type:"photo",image:K(e.image_url),emoji:e.emojis,back:e.text})},right:"모두가 볼 수 있게 남겨요",onDumpRight:async()=>{r.emit("loading",!0);const e=await Q(u,(t==null?void 0:t.type)==="photo"?t.emoji:"","public",i);r.emit("loading",!1),r.emit("pushCard",{idx:e.idx,ownerIdx:String(O()),type:"photo",image:K(e.image_url),emoji:e.emojis,back:e.text})},rightColor:"positive",onLoad:async()=>{try{const{base64Url:e,metadata:C}=await Et();if(a=e,i=C,a.length===0)throw new Error("No images selected")}catch{r.emit("removeCardByIdx",{idx:o}),r.emit("pushCard",{idx:"102",type:"message",front:"사진을 불러오지 못했어요",back:"사진을 불러오지 못했어요",left:"넘어갈게",right:"넘어갈게"});return}r.emit("setCardByIdx",{idx:o,card:{image:a}}),ct.set({isOpen:!0,type:"emoji"}),u=await Dt(a),t=Y(pt).find(e=>e.idx===o)}})}function yt(s){let a,i,u,t,o,e,C,l,d,R="카드 덱 불러오기",$,p,S="카드 하나 추가하기",I,B,N="로그아웃",j,m,P="카드 신규 등록하기",y,T,M;i=new rt({});function X(n){s[2](n)}let L={};return s[0]!==void 0&&(L.cards=s[0]),t=new st({props:L}),tt.push(()=>ot(t,"cards",X)),{c(){a=f("div"),V(i.$$.fragment),u=b(),V(t.$$.fragment),e=b(),C=f("div"),l=f("div"),d=f("button"),d.textContent=R,$=b(),p=f("button"),p.textContent=S,I=b(),B=f("button"),B.textContent=N,j=b(),m=f("button"),m.textContent=P,this.h()},l(n){a=x(n,"DIV",{class:!0});var c=U(a);J(i.$$.fragment,c),c.forEach(A),u=w(n),J(t.$$.fragment,n),e=w(n),C=x(n,"DIV",{class:!0});var D=U(C);l=x(D,"DIV",{class:!0});var g=U(l);d=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(d)!=="svelte-1ypo7e6"&&(d.textContent=R),$=w(g),p=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(p)!=="svelte-34rce8"&&(p.textContent=S),I=w(g),B=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(B)!=="svelte-697xgu"&&(B.textContent=N),j=w(g),m=x(g,"BUTTON",{class:!0,"data-svelte-h":!0}),_(m)!=="svelte-108817t"&&(m.textContent=P),g.forEach(A),D.forEach(A),this.h()},h(){E(a,"class","fixed inset-0"),E(d,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(p,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(B,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(m,"class","w-full bg-blue-500 text-white p-4 rounded-lg"),E(l,"class","flex gap-4"),E(C,"class","fixed w-full bottom-0 p-6 z-[100]")},m(n,c){v(n,a,c),q(i,a,null),v(n,u,c),q(t,n,c),v(n,e,c),v(n,C,c),h(C,l),h(l,d),h(l,$),h(l,p),h(l,I),h(l,B),h(l,j),h(l,m),y=!0,T||(M=[k(d,"click",F(s[3])),k(p,"click",F(s[4])),k(B,"click",F(s[5])),k(m,"click",F(wt))],T=!0)},p(n,[c]){const D={};!o&&c&1&&(o=!0,D.cards=n[0],et(()=>o=!1)),t.$set(D)},i(n){y||(z(i.$$.fragment,n),z(t.$$.fragment,n),y=!0)},o(n){G(i.$$.fragment,n),G(t.$$.fragment,n),y=!1},d(n){n&&(A(a),A(u),A(e),A(C)),H(i),H(t,n),T=!1,ut(M)}}}function _t(s,a,i){let u=[{idx:"1",type:"photo",image:"/h1.jpeg",emoji:"🧸🎀✨💎✨🎀",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 위에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"10",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"top",pushOffset:300})}},{idx:"2",type:"photo",image:"/h2.png",emoji:"🔥🌴😆🚂",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 오른쪽에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"9",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"right",pushOffset:300})}},{idx:"3",type:"photo",image:"/h1.jpeg",emoji:"🧸🎀✨💎✨🎀",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 아래에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"8",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"bottom",pushOffset:300})}},{idx:"4",type:"photo",image:"/h2.png",emoji:"🔥🌴😆🚂",back:"카드 뒷면입니다",left:"넘어갈게",right:"카드 왼쪽에서 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"7",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기",pushAnimation:!0,pushDirection:"left",pushOffset:300})}},{idx:"5",ownerIdx:"5",type:"photo",image:"/h1.jpeg",emoji:"👀👀👀👀👀",back:"첫눈 오는 날, 눈 코에 묻히고 공 물고 웃던 너. 그 순간이 겨울의 선물 같았어.",left:"넘어갈게",right:"카드 한장 뿅하고 불러오기",rightColor:"positive",onDumpRight:()=>{r.emit("pushCard",{idx:"6",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"버리기",right:"버리기"})}}];const t=u;function o(d){u=d,i(0,u)}return[u,t,o,()=>{r.emit("setCards",t)},()=>{r.emit("pushCard",{idx:"10",type:"message",front:"메시지 카드 앞면입니다",back:"카드 뒷면입니다",left:"넘어갈게",right:"넘어갈게"})},()=>{Bt()}]}class St extends at{constructor(a){super(),it(this,a,_t,yt,Z,{})}}export{St as component};
